{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}{{ project.code }} | Project Tracker{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Add styles for our new autosave indicator */
    .autosave-indicator {
        display: inline-block;
        width: 20px; /* Reserve space */
        text-align: center;
        margin-right: 5px;
    }

    /* Style for stages marked as "Not Applicable" */
    .stage-not-applicable {
        background-color: #f8f9fa !important;
        opacity: 0.65;
    }
    .stage-not-applicable td,
    .stage-not-applicable strong {
        text-decoration: line-through;
        color: #6c757d !important;
    }

    /* Styles for table icons to match the timeline component */
    .table-status-icon {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 0.7rem;
        margin-right: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }
    .table-status-icon.status-completed { background-color: var(--success); }
    .table-status-icon.status-in-progress { background-color: var(--warning); color: #000; }
    .table-status-icon.status-hold { background-color: var(--danger); }
    .table-status-icon.status-not-applicable { background-color: var(--gray); }
    .table-status-icon.status-not-started { background-color: transparent; border: 2px solid #adb5bd; }


    .remark-item {
    display: flex;
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}
.remark-avatar {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--secondary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 1rem;
}
.remark-content {
    flex-grow: 1;
}
.remark-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.25rem;
}
.remark-author {
    font-size: 0.9rem;
    color: var(--dark);
}
.remark-timestamp {
    font-size: 0.75rem;
    color: var(--gray);
}
.remark-text {
    font-size: 0.95rem;
    color: #333;
}

    /* Styles for the Timeline from your preferred version */
    .roadmap { display: flex; position: relative; padding: 0 5px; margin-top: 30px; margin-bottom: 70px; height: 80px; }
    .roadmap-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; flex: 1; text-align: center; }
    .roadmap-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 0 0 4px #f5f7fb; position: relative; z-index: 2; flex-shrink: 0; transition: all 0.3s ease; }
    .roadmap-step:hover .roadmap-circle { transform: scale(1.1); }
    .roadmap-label { font-weight: 500; font-size: 0.8rem; color: #1b263b; margin-top: 10px; height: 50px; display: flex; align-items: center; }
    .roadmap-line { position: absolute; top: 18px; left: 0; right: 0; height: 4px; background-color: #dee2e6; z-index: 1; }
    .roadmap-progress { position: absolute; top: 18px; left: 0; height: 4px; background-color: #28a745; z-index: 2; transition: width 0.4s ease; }
    
    .status-Completed { background-color: var(--success); color: white; } 
    .status-InProgress { background-color: var(--warning); color: black; } 
    .status-Notstarted { background-color: #adb5bd; color: white; } 
    .status-Hold { background-color: var(--danger); color: white; } 
    .status-NotApplicable { background-color: var(--gray); color: white; }

    /* Styles for the Update Feed from the polished lower section */
    .bg-danger-soft { background-color: rgba(220, 53, 69, 0.1); }
    .bg-warning-soft { background-color: rgba(255, 193, 7, 0.1); }
    .bg-info-soft { background-color: rgba(13, 202, 240, 0.1); }
    .bg-success-soft { background-color: rgba(25, 135, 84, 0.1); }

    /* New style for remark items */
    .remark-box {
        background-color: #f8f9fa;
        border-left: 3px solid #0d6efd;
        padding: 10px;
        margin-top: 10px;
    }

    /* Professional Table Styling */
    .table-card {
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        background: #fff;
    }
    .stage-table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }
    .stage-table thead th {
        background-color: #f8f9fa;
        color: #4b5563;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        white-space: nowrap;
    }
    .stage-table tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        color: #1f2937;
        font-size: 0.875rem;
    }
    .stage-table tbody tr:last-child td {
        border-bottom: none;
    }
    .stage-table tbody tr:hover {
        background-color: #f9fafb;
    }
    
    /* Form controls inside table */
    .stage-table .form-control-sm, 
    .stage-table .form-select-sm {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 6px 10px;
        font-size: 0.8125rem;
        transition: all 0.2s ease;
    }
    .stage-table .form-control-sm:focus, 
    .stage-table .form-select-sm:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Progress bar styling */
    .stage-table .progress {
        height: 6px !important;
        background-color: #e5e7eb;
        border-radius: 9999px;
        margin-top: 8px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    .stage-table .progress-bar {
        border-radius: 9999px;
    }
    
    /* MS Loop-style Table */
    .loop-table th {
        font-weight: 600;
        color: #6b7280;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 10px;
        text-align: left;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .loop-table td {
        border-bottom: 1px solid #f3f4f6;
        padding: 8px 5px;
        vertical-align: middle;
    }
    .loop-table .form-control, 
    .loop-table .form-select {
        border: 1px solid transparent;
        background-color: transparent;
        font-size: 0.9rem;
        padding: 6px 8px;
    }
    .loop-table .form-control:hover, 
    .loop-table .form-select:hover {
        background-color: #f9fafb;
    }
    .loop-table .form-control:focus, 
    .loop-table .form-select:focus {
        background-color: #fff;
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    /* Select2 adjustments for table */
    .loop-table .select2-container--bootstrap-5 .select2-selection {
        border-color: transparent;
        background-color: transparent;
        min-height: 32px;
    }
    .loop-table .select2-container--bootstrap-5 .select2-selection:hover {
        background-color: #f9fafb;
    }
    /* Enhanced Select2 Tags for Loop Table */
    .loop-table .select2-container--bootstrap-5 .select2-selection__choice {
        background-color: #eef2ff !important; /* Light Indigo */
        color: #4338ca !important; /* Indigo 700 */
        border: 1px solid #c7d2fe !important;
        border-radius: 50rem !important; /* Pill shape */
        padding: 3px 10px 3px 24px !important; /* Adjusted padding for a tighter fit */
        font-size: 0.75rem !important;
        font-weight: 600;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        position: relative;
    }
    .loop-table .select2-container--bootstrap-5 .select2-selection__choice__remove {
        border: none !important;
        background: transparent !important;
        color: #4338ca !important;
        position: absolute !important;
        left: 4px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        padding: 0 !important;
        margin: 0 !important;
        opacity: 0.6;
        transition: opacity 0.2s;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-indent: 0 !important;
    }
    /* Remarks scroll container in table */
    .remark-scroll-container::-webkit-scrollbar {
        width: 3px;
    }
    .remark-scroll-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
    }
    /* Restore the 'x' using a pseudo-element since we removed the background image */
    .loop-table .select2-container--bootstrap-5 .select2-selection__choice__remove::before {
        content: "\00d7"; /* Multiplication sign */
        font-size: 1rem;
        line-height: 1;
    }
    .loop-table .select2-container--bootstrap-5 .select2-selection__choice__remove:hover {
        opacity: 1;
        background-color: rgba(67, 56, 202, 0.1) !important;
        border-radius: 50%;
        color: #312e81 !important;
    }

    /* Project Notes Styling */
    .project-notes-feed {
        height: 500px; /* Fixed height window */
        overflow-y: auto;
        padding: 15px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .project-notes-feed::-webkit-scrollbar {
        width: 6px;
    }
    .project-notes-feed::-webkit-scrollbar-track {
        background: #f1f1f1; 
    }
    .project-notes-feed::-webkit-scrollbar-thumb {
        background: #d1d5db; 
        border-radius: 3px;
    }
    .note-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        transition: all 0.2s ease;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .note-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
    }
    .note-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 12px;
        bottom: 12px;
        width: 4px;
        background-color: #3b82f6;
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .note-author {
        font-weight: 600;
        color: #111827;
        font-size: 0.9rem;
    }
    .note-time {
        font-size: 0.75rem;
        color: #6b7280;
        background-color: #f3f4f6;
        padding: 2px 8px;
        border-radius: 12px;
    }
    .note-content {
        color: #374151;
        font-size: 0.95rem;
        line-height: 1.6;
        padding-left: 10px; 
    }
    .note-avatar-small {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        margin-right: 10px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}


{% block content %}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="page-title">{{ project.code }} - {{ project.customer_name }}</h1>
            <p class="page-subtitle">{{project.segment_con.name|default:'No Segment'}}</p>
        </div>
        <div>
            <a href="{% url 'tracker_edit_project' project.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-2"></i>Edit Project
            </a>
        </div>
    </div>
    
    <div class="card mb-4"> {# This is the main card for consolidated details #}
        <div class="card-body">
            <div class="row align-items-center mb-3">
                <div class="col-md-4 border-end">
                    <h6 class="text-muted">Project Value</h6>
                    <h4 class="card-title">â‚¹{{ project.value|intcomma }}</h4>
                </div>
                <div class="col-md-4 border-end">
                    <h6 class="text-muted">SO Punch Date</h6>
                    <h4 class="card-title">{{ project.so_punch_date|date:"M d, Y" }}</h4>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">Team Lead (PACe)</h6>
                    <h4 class="card-title">{{ project.team_lead.name|default:'N/A' }}</h4>
                </div>
            </div>
            <hr>
            <div class="progress-wrapper mt-3">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Overall Completion</span>
                    <span class="text-primary fw-bold">{{ completion_percentage }}%</span>
                </div>
                <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-primary" role="progressbar"
                         style="width: {{ completion_percentage }}%;"
                         aria-valuenow="{{ completion_percentage }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Summary & Activity Toggle -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-header-title mb-0"><i class="fas fa-info-circle me-2"></i>Project Summary</h5>
        <a href="{% url 'tracker_project_activity' project.id %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-history me-1"></i> View Recent Activity
        </a>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <h6 class="text-muted">Current Status</h6>
            <div class="d-flex align-items-center mt-1">
                <span class="badge fs-6 {% if overall_status == 'Completed' %}bg-success{% elif overall_status == 'In Progress' %}bg-warning text-dark{% elif overall_status == 'Hold' %}bg-danger{% else %}bg-secondary{% endif %} me-3">{{ overall_status }}</span>
                {% if last_update_time %}<small class="text-muted"><i class="far fa-clock me-1"></i>Last updated: {{ last_update_time|date:"M d, Y" }}</small>{% endif %}
            </div>
        </div>
        <hr>
        <div class="row mb-3">
            <div class="col-md-6 border-end">
                <h6 class="text-muted">Overall Project OTIF %</h6>
                <div class="mt-1">
                    {% if overall_otif_percentage is not None %}
                        <span class="fs-5 fw-bold {% if overall_otif_percentage >= 100 %}text-success{% elif overall_otif_percentage >= 80 %}text-warning{% else %}text-danger{% endif %}">{{ overall_otif_percentage }}%</span>
                        <small class="text-muted ms-2">(Based on completed stages)</small>
                    {% else %}
                        <span class="text-muted small">No completed stages yet</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted">Project OTIF (Handover)</h6>
                <div class="mt-1">
                    {% if project_otif is not None %}
                        {% if project_otif == 101 %}<span class="badge bg-success">Before Time</span>
                        {% elif project_otif == 100 %}<span class="badge bg-primary">On Time</span>
                        {% else %}<span class="badge bg-danger">Delayed</span>{% endif %}
                    {% else %}
                        <span class="text-muted small">Pending Handover Completion</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <hr>
        <div class="row mb-3">
            <div class="col-md-6 border-end">
                <h6 class="text-muted">Next Automation Milestone</h6>
                {% if next_automation_milestone %}
                    <strong>{{ next_automation_milestone.name }}</strong>
                    <div class="text-muted small mt-1">Planned: {{ next_automation_milestone.planned_date|date:"M d, Y" }}</div>
                {% else %}
                    <p class="text-muted mb-0 small">All automation stages complete.</p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h6 class="text-muted">Next Emulation Milestone</h6>
                {% if next_emulation_milestone %}
                    <strong>{{ next_emulation_milestone.name }}</strong>
                    <div class="text-muted small mt-1">Planned: {{ next_emulation_milestone.planned_date|date:"M d, Y" }}</div>
                {% else %}
                    <p class="text-muted mb-0 small">All emulation stages complete.</p>
                {% endif %}
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6 border-end">
                 <h6 class="text-muted">Automation Schedule</h6>
                 {% with schedule_status=automation_schedule_status %}
                    {% if schedule_status is not None %}{% if schedule_status > 0 %}<span class="badge bg-danger">Delayed by {{ schedule_status }} day{{ schedule_status|pluralize }}</span>{% elif schedule_status < 0 %}<span class="badge bg-success">Ahead by {{ schedule_status|abs }} day{{ schedule_status|abs|pluralize }}</span>{% else %}<span class="badge bg-primary">On Time</span>{% endif %}{% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                 {% endwith %}
            </div>
             <div class="col-md-6">
                <h6 class="text-muted">Emulation Schedule</h6>
                {% with schedule_status=emulation_schedule_status %}
                   {% if schedule_status is not None %}{% if schedule_status > 0 %}<span class="badge bg-danger">Delayed by {{ schedule_status }} day{{ schedule_status|pluralize }}</span>{% elif schedule_status < 0 %}<span class="badge bg-success">Ahead by {{ schedule_status|abs }} day{{ schedule_status|abs|pluralize }}</span>{% else %}<span class="badge bg-primary">On Time</span>{% endif %}{% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                {% endwith %}
           </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title mb-0"><i class="fas fa-cogs"></i>Automation Timeline</h5></div>
            <div class="card-body">
                <div class="roadmap">
                    <div class="roadmap-line"></div>
                    <div class="roadmap-progress" style="width: {{ timeline_progress_auto }}%;"></div>
                    {% for stage in automation_stages %}
                        {% with status=stage.status|default:"Not started" %}
                        <div class="roadmap-step">
                            <div class="roadmap-circle status-{{ status|cut:' '|capfirst }}" data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="top" title="<strong>{{ stage.name }}</strong><br>Status: {{ status }}<br>{% if stage.planned_date %}Planned: {{ stage.planned_date|date:'M d, Y' }}{% endif %}<br>{% if stage.actual_date %}Actual: {{ stage.actual_date|date:'M d, Y' }}{% endif %}">

                                {% if status == "Completed" %}<i class="fas fa-check"></i>
                                {% elif status == "In Progress" %}<i class="fas fa-spinner fa-spin"></i>
                                {% elif status == "Hold" %}<i class="fas fa-pause"></i>
                                {% elif status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                {% else %}<i class="far fa-circle"></i>
                                {% endif %}
                            </div>
                            <div class="roadmap-label">{{ stage.name }}</div>
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title mb-0"><i class="fas fa-gamepad"></i>Emulation Timeline</h5></div>
            <div class="card-body">
                <div class="roadmap">
                    <div class="roadmap-line"></div>
                    <div class="roadmap-progress" style="width: {{ timeline_progress_emu }}%;"></div>
                    {% for stage in emulation_stages %}
                        {% with status=stage.status|default:"Not started" %}
                        <div class="roadmap-step">
                            <div class="roadmap-circle status-{{ status|cut:' '|capfirst }}" data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="top" title="<strong>{{ stage.name }}</strong><br>Status: {{ status }}<br>{% if stage.planned_date %}Planned: {{ stage.planned_date|date:'M d, Y' }}{% endif %}<br>{% if stage.actual_date %}Actual: {{ stage.actual_date|date:'M d, Y' }}{% endif %}">

                                {% if status == "Completed" %}<i class="fas fa-check"></i>
                                {% elif status == "In Progress" %}<i class="fas fa-spinner fa-spin"></i>
                                {% elif status == "Hold" %}<i class="fas fa-pause"></i>
                                {% elif status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                {% else %}<i class="far fa-circle"></i>
                                {% endif %}
                            </div>
                            <div class="roadmap-label">{{ stage.name }}</div>
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="stageTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab != 'emulation' %}active{% endif %}" id="automation-tab" data-bs-toggle="tab" data-bs-target="#automation-content" type="button" role="tab"><i class="fas fa-cogs me-2"></i>Automation</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab == 'emulation' %}active{% endif %}" id="emulation-tab" data-bs-toggle="tab" data-bs-target="#emulation-content" type="button" role="tab"><i class="fas fa-gamepad me-2"></i>Emulation</button></li>
        </ul>
        <div class="tab-content" id="stageTabsContent">
            <div class="tab-pane fade {% if request.GET.active_tab != 'emulation' %}show active{% endif %}" id="automation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="automationStagesForm">
                    {% csrf_token %}<input type="hidden" name="active_tab" value="automation">
                    <div class="d-flex justify-content-end align-items-center mb-3">

                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#allRemarksModalAutomation">
                                <i class="fas fa-comments me-1"></i> View All Remarks
                            </button>

                        <button type="submit" name="save_all_automation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Automation</button>
                    </div>

                    <div class="table-responsive table-card"><table class="table stage-table align-middle mb-0"><thead><tr><th style="width:20%">Stage</th><th style="width:12%">Planned Finish Date</th><th style="width:15%">Status</th><th style="width:15%">% Completion</th><th style="width:12%">Start Date</th><th style="width:12%">Finish Date</th><th style="width:14%">Actions</th></tr></thead><tbody>

                        {% for stage in automation_stages %}
                        <tr class="{% if stage.status == 'Not Applicable' %}stage-not-applicable{% endif %}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="table-status-icon status-{{ stage.status|slugify }}">
                                        {% if stage.status == 'Completed' %}<i class="fas fa-check"></i>
                                        {% elif stage.status == 'In Progress' %}<i class="fas fa-ellipsis-h"></i>
                                        {% elif stage.status == 'Hold' %}<i class="fas fa-pause"></i>
                                        {% elif stage.status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                        {% else %}{% comment %} Empty for Not Started to show the outline circle {% endcomment %}
                                        {% endif %}
                                    </div>
                                    <strong>{{ stage.name }}</strong>
                                </div>
                            </td>

                            <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                            <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select autosave-input" data-stage-id="{{ stage.id }}" data-field-name="status">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <input type="number" name="completion_percentage_{{ stage.id }}" class="form-control form-control-sm autosave-input me-1" data-stage-id="{{ stage.id }}" data-field-name="completion_percentage" value="{{ stage.completion_percentage|default:0 }}" min="0" max="100" style="width: 65px;" {% if stage.status != 'In Progress' %}disabled{% endif %}>
                                    <span class="text-muted small">%</span>
                                </div>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ stage.completion_percentage|default:0 }}%;" aria-valuenow="{{ stage.completion_percentage|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            <td><input type="date" name="planned_start_date_{{ stage.id }}" class="form-control form-control-sm autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_start_date" value="{{ stage.planned_start_date|date:'Y-m-d' }}"></td>

                            <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="actual_date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="autosave-indicator" id="autosave-indicator-{{ stage.id }}"></span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
                                        <ul class="dropdown-menu">
                                            <li><button type="submit" class="dropdown-item" name="stage_id" value="{{ stage.id }}"><i class="fas fa-save me-2"></i>Save Stage</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-2"></i>History</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus-circle me-2"></i>Add Remark</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye me-2"></i>View Remarks</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody></table></div>
                </form>
            </div>
            <div class="tab-pane fade {% if request.GET.active_tab == 'emulation' %}show active{% endif %}" id="emulation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="emulationStagesForm">
                    {% csrf_token %}<input type="hidden" name="active_tab" value="emulation">
                    <div class="d-flex justify-content-end align-items-center mb-3">

                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#allRemarksModalEmulation">
                                <i class="fas fa-comments me-1"></i> View All Remarks
                            </button>

                        <button type="submit" name="save_all_emulation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Emulation</button>
                    </div>

                    <div class="table-responsive table-card"><table class="table stage-table align-middle mb-0"><thead><tr><th style="width:20%">Stage</th><th style="width:12%">Planned Finish Date</th><th style="width:15%">Status</th><th style="width:15%">% Completion</th><th style="width:12%">Start Date</th><th style="width:12%">Finish Date</th><th style="width:14%">Actions</th></tr></thead><tbody>

                        {% for stage in emulation_stages %}
                        <tr class="{% if stage.status == 'Not Applicable' %}stage-not-applicable{% endif %}">
                           <td>
                                <div class="d-flex align-items-center">
                                    <div class="table-status-icon status-{{ stage.status|slugify }}">
                                        {% if stage.status == 'Completed' %}<i class="fas fa-check"></i>
                                        {% elif status == 'In Progress' %}<i class="fas fa-ellipsis-h"></i>
                                        {% elif status == 'Hold' %}<i class="fas fa-pause"></i>
                                        {% elif status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                        {% else %}{% comment %} Empty for Not Started to show the outline circle {% endcomment %}
                                        {% endif %}
                                    </div>
                                    <strong>{{ stage.name }}</strong>
                                </div>
                            </td>

                            <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                            <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select autosave-input" data-stage-id="{{ stage.id }}" data-field-name="status">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <input type="number" name="completion_percentage_{{ stage.id }}" class="form-control form-control-sm autosave-input me-1" data-stage-id="{{ stage.id }}" data-field-name="completion_percentage" value="{{ stage.completion_percentage|default:0 }}" min="0" max="100" style="width: 65px;" {% if stage.status != 'In Progress' %}disabled{% endif %}>
                                    <span class="text-muted small">%</span>
                                </div>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ stage.completion_percentage|default:0 }}%;" aria-valuenow="{{ stage.completion_percentage|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            <td><input type="date" name="planned_start_date_{{ stage.id }}" class="form-control form-control-sm autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_start_date" value="{{ stage.planned_start_date|date:'Y-m-d' }}"></td>

                            <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="actual_date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="autosave-indicator" id="autosave-indicator-{{ stage.id }}"></span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
                                        <ul class="dropdown-menu">
                                            <li><button type="submit" class="dropdown-item" name="stage_id" value="{{ stage.id }}"><i class="fas fa-save me-2"></i>Save Stage</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-2"></i>History</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus-circle me-2"></i>Add Remark</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye me-2"></i>View Remarks</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody></table></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4" id="project-notes">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="notesPushPullTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-content" type="button" role="tab" aria-controls="notes-content" aria-selected="true">
                    <i class="far fa-sticky-note me-2"></i>Project Notes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="push-pull-tab" data-bs-toggle="tab" data-bs-target="#push-pull-content" type="button" role="tab" aria-controls="push-pull-content" aria-selected="false">
                    <i class="fas fa-table me-2"></i>Push-Pull Contents
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="notesPushPullTabsContent">
            <!-- Project Notes Tab -->
            <div class="tab-pane fade show active" id="notes-content" role="tabpanel" aria-labelledby="notes-tab">
                <div class="p-3 bg-light">
                    <div class="project-notes-feed">
                        {% for comment in project_comments %}
                            <div class="note-card">
                                <div class="note-header">
                                    <div class="d-flex align-items-center">
                                        <div class="note-avatar-small">{{ comment.added_by.username|slice:":2"|upper }}</div>
                                        <span class="note-author">{{ comment.added_by.username|default:'Unknown' }}</span>
                                    </div>
                                    <span class="note-time"><i class="far fa-clock me-1"></i>{{ comment.created_at|naturaltime }}</span>
                                </div>
                                <div class="note-content">{{ comment.text|linebreaksbr }}</div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted p-4">
                                <i class="far fa-clipboard fa-2x mb-3 text-secondary opacity-50"></i>
                                <p>No notes added yet.</p>
                            </div>
                        {% endfor %}
                    </div>
                    <form method="POST" action="{% url 'tracker_project_detail' project.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="active_tab" value="{{ request.GET.active_tab|default:'automation' }}">
                        <div class="d-flex gap-2">
                            <textarea name="note_text" class="form-control shadow-sm border-0" rows="2" placeholder="Type a note here..." required style="resize: none;"></textarea>
                            <button type="submit" name="add_project_comment" value="1" class="btn btn-primary px-4 align-self-end"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Push-Pull Contents Tab -->
            <div class="tab-pane fade" id="push-pull-content" role="tabpanel" aria-labelledby="push-pull-tab">
                <div class="table-responsive">
                    <table class="table loop-table mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 12%;">Type</th>
                                <th style="width: 35%;">Description</th>
                                <th style="width: 20%;">Who</th>
                                <th style="width: 12%;">ETA</th>
                                <th style="width: 11%;">Status</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for update in updates %}
                            <tr>
                                <td>
                                    <select class="form-select form-select-sm autosave-update-input" data-id="{{ update.id }}" data-field="push_pull_type">
                                        {% for val, label in update.PUSH_PULL_CHOICES %}
                                        <option value="{{ val }}" {% if update.push_pull_type == val %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm autosave-update-input" data-id="{{ update.id }}" data-field="text" value="{{ update.text }}">
                                </td>
                                <td>
                                    <select class="form-select form-select-sm select2-update-who" multiple data-id="{{ update.id }}" data-field="who_contact">
                                        {% for person in contact_persons %}
                                        <option value="{{ person.id }}" {% if person in update.who_contact.all %}selected{% endif %}>{{ person.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="date" class="form-control form-control-sm autosave-update-input" data-id="{{ update.id }}" data-field="eta" value="{{ update.eta|date:'Y-m-d' }}">
                                </td>
                                <td>
                                    <select class="form-select form-select-sm autosave-update-input" data-id="{{ update.id }}" data-field="status">
                                        {% for val, label in update.STATUS_CHOICES %}
                                        <option value="{{ val }}" {% if update.status == val %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-link text-primary p-0 me-3" data-bs-toggle="modal" data-bs-target="#localUpdateRemarksModal{{ update.id }}" title="View Details"><i class="fas fa-eye"></i></button>
                                    <a href="{% url 'delete_project_update' update.id %}" class="btn btn-sm btn-link text-danger p-0" title="Delete" onclick="return confirm('Are you sure you want to delete this item?');"><i class="far fa-trash-alt"></i></a>
                                    <span id="update-indicator-{{ update.id }}" class="ms-2" style="display:inline-block; width:15px;"></span>
                                </td>
                            </tr>
                        {% endfor %}
                            
                            <!-- New Row (Hidden by default) -->
                            <tr id="new-update-row" style="display: none; background-color: #f8f9fa;">
                                    <td>
                                        <select name="push_pull_type" class="form-select form-select-sm" form="new-update-form">
                                            <option value="Pull" selected>Pull Content</option>
                                            <option value="Push">Push Content</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" name="update_text" class="form-control form-control-sm" placeholder="Description" required form="new-update-form">
                                    </td>
                                    <td>
                                        <select name="who_contact" class="form-select form-select-sm select2-new-who" multiple form="new-update-form">
                                            {% for person in contact_persons %}
                                                <option value="{{ person.id }}">{{ person.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="date" name="eta_date" class="form-control form-control-sm" form="new-update-form">
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">Open</span>
                                    </td>
                                    <td class="text-end">
                                        <button type="submit" class="btn btn-sm btn-primary" form="new-update-form"><i class="fas fa-plus"></i></button>
                                    </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Hidden form for the new row, placed outside the table for valid HTML -->
                <form id="new-update-form" action="{% url 'add_project_update' project.id %}" method="post" style="display:none;">
                    {% csrf_token %}
                </form>
                <div class="p-2 border-top">
                    <button class="btn btn-sm btn-light text-primary fw-bold" onclick="document.getElementById('new-update-row').style.display = 'table-row'; this.style.display='none';">
                        <i class="fas fa-plus me-1"></i> Add Row
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


{% for stage in automation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}
{% for stage in emulation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}
{% include 'tracker/partials/project_update_modals.html' with updates=updates contact_persons=contact_persons %}
{% include 'tracker/partials/all_remarks_modals.html' %}

<!-- Local Update Remarks Modals to ensure functionality -->
{% for update in updates %}
<div class="modal fade" id="localUpdateRemarksModal{{ update.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted small text-uppercase">Description</h6>
                        <p class="fw-bold">{{ update.text }}</p>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted small text-uppercase">Type</h6>
                        <span class="badge {% if update.push_pull_type == 'Push' %}bg-info{% else %}bg-warning text-dark{% endif %}">{{ update.get_push_pull_type_display }}</span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h6 class="text-muted small text-uppercase">Status</h6>
                        <span class="badge {% if update.status == 'Closed' %}bg-success{% else %}bg-secondary{% endif %}">{{ update.status }}</span>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted small text-uppercase">Who</h6>
                        <div>
                            {% for person in update.who_contact.all %}
                                <span class="badge bg-light text-dark border me-1">{{ person.name }}</span>
                            {% empty %}
                                <span class="text-muted small">-</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted small text-uppercase">ETA</h6>
                        <p>{{ update.eta|date:"M d, Y"|default:"-" }}</p>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <h6><i class="far fa-comments me-2"></i>Remarks</h6>
                    <div class="project-notes-feed" style="height: 300px;" id="remarks-container-{{ update.id }}">
                        {% for remark in update.remarks.all %}
                            <div class="note-card">
                                <div class="note-header">
                                    <div class="d-flex align-items-center">
                                        <div class="note-avatar-small">{{ remark.added_by.username|slice:":2"|upper }}</div>
                                        <span class="note-author">{{ remark.added_by.username }}</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="note-time me-2"><i class="far fa-clock me-1"></i>{{ remark.created_at|naturaltime }}</span>
                                        {% if request.user == remark.added_by or request.user.is_staff %}
                                        <form action="{% url 'delete_update_remark' remark.id %}" method="POST" class="d-inline" onsubmit="return confirm('Delete this remark?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="redirect_to" value="project_detail">
                                            <button type="submit" class="btn btn-link text-danger p-0 lh-1" style="font-size: 0.9rem;"><i class="fas fa-times"></i></button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="note-content">{{ remark.text|linebreaksbr }}</div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted p-4">
                                <i class="far fa-comment-dots fa-2x mb-2 opacity-50"></i>
                                <p class="small mb-0">No remarks yet.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <form action="{% url 'add_update_remark' update.id %}" method="POST" class="ajax-remark-form" data-update-id="{{ update.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="redirect_to" value="project_detail">
                    <div class="d-flex gap-2">
                        <textarea class="form-control shadow-sm border-0" id="remarkText{{ update.id }}" name="remark_text" rows="2" required placeholder="Type a remark..." style="resize: none;"></textarea>
                        <button type="submit" class="btn btn-primary px-3 align-self-end"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}


{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Select2 for the "new row"
        $('.select2-new-who').select2({
            tags: true,
            tokenSeparators: [','],
            theme: 'bootstrap-5',
            placeholder: "Select or type person(s)",
            width: '100%',
            createTag: function(params) {
                const term = $.trim(params.term);
                if (term === '' || $.isNumeric(term)) {
                    return null;
                }
                const existingOptions = $(this).find('option');
                const isExisting = existingOptions.filter(function() {
                    return $.trim($(this).text()).toLowerCase() === term.toLowerCase();
                }).length > 0;
                
                if (isExisting) {
                    return null;
                }
                return {
                    id: term,
                    text: term,
                    new: true
                };
            },
            templateResult: function (data) {
                if (data.new) {
                    // Use a jQuery object to correctly render the HTML
                    var $result = $('<span><b>(New)</b> ' + data.text + '</span>');
                    return $result;
                }
                return data.text;
            }
        });
        
        // Handle new tags (persons) being added via AJAX
        $('.select2-new-who').on('select2:select', function (e) {
            const data = e.params.data;
            if (data.new) {
                const $select = $(this);
                $.ajax({
                    url: "{% url 'add_contact_person_ajax' %}",
                    method: 'POST',
                    data: { name: data.text, csrfmiddlewaretoken: '{{ csrf_token }}' },
                    success: function(response) {
                        if(response.status === 'success') {
                            const newOption = new Option(response.name, response.id, false, false);
                            $select.find(`option[value="${data.id}"]`).remove();
                            $select.append(newOption).trigger('change');
                            const currentSelection = $select.val() || [];
                            currentSelection.push(response.id);
                            $select.val(currentSelection).trigger('change');
                        } else {
                            alert('Error creating new contact.');
                            const currentSelection = $select.val() || [];
                            const updatedSelection = currentSelection.filter(item => item !== data.id);
                            $select.val(updatedSelection).trigger('change');
                        }
                    },
                    error: function() {
                        alert('Error creating new contact.');
                        const currentSelection = $select.val() || [];
                        const updatedSelection = currentSelection.filter(item => item !== data.id);
                        $select.val(updatedSelection).trigger('change');
                    }
                });
            }
        });

        // Initialize Select2 for existing rows (Inline Editing)
        $('.select2-update-who').each(function() {
            $(this).select2({
                tags: true,
                tokenSeparators: [','],
                theme: 'bootstrap-5',
                placeholder: "Select person(s)",
                width: '100%',
                createTag: function(params) {
                    const term = $.trim(params.term);
                    if (term === '' || $.isNumeric(term)) { return null; }
                    return { id: term, text: term, new: true };
                },
                templateResult: function (data) {
                    if (data.new) { return $('<span><b>(New)</b> ' + data.text + '</span>'); }
                    return data.text;
                }
            }).on('change', function(e) {
                // Trigger autosave manually on change
                const select = e.target;
                const updateId = select.dataset.id;
                const field = select.dataset.field;
                const value = $(select).val(); // Array of IDs
                handleUpdateAutosave(updateId, field, value);
            }).on('select2:select', function(e) {
                // Handle new tag creation via AJAX inside the table
                const data = e.params.data;
                if (data.new) {
                    const $select = $(this);
                    $.ajax({
                        url: "{% url 'add_contact_person_ajax' %}",
                        method: 'POST',
                        data: { name: data.text, csrfmiddlewaretoken: '{{ csrf_token }}' },
                        success: function(response) {
                            if(response.status === 'success') {
                                const newOption = new Option(response.name, response.id, false, false);
                                $select.find(`option[value="${data.id}"]`).remove();
                                $select.append(newOption).trigger('change');
                                // The change event above will handle the autosave
                            } else {
                                alert('Error creating new contact.');
                            }
                        },
                        error: function() {
                            alert('Error creating new contact.');
                        }
                    });
                }
            });
        });


        // Initialize Select2 for the edit modals when they are shown
        $('.select2-multiple-edit').each(function() {
            if (!$(this).data('select2')) { // Check if Select2 is already initialized
                $(this).select2({
                    tags: true,
                    tokenSeparators: [','],
                    theme: 'bootstrap-5',
                    placeholder: "Select or type person(s)",
                    width: '100%',
                    createTag: function(params) {
                        const term = $.trim(params.term);
                        if (term === '' || $.isNumeric(term)) {
                            return null;
                        }
                        return { id: term, text: term, new: true };
                    },
                    templateResult: function (data) {
                        if (data.new) {
                             var $result = $('<span><b>(New)</b> ' + data.text + '</span>');
                             return $result;
                        }
                        return data.text;
                    }
                });
                
                // Add the AJAX handler for new tags in edit modals as well
                $(this).on('select2:select', function(e) {
                    const data = e.params.data;
                    if (data.new) {
                        const $select = $(this);
                        $.ajax({
                            url: "{% url 'add_contact_person_ajax' %}",
                            method: 'POST',
                            data: { name: data.text, csrfmiddlewaretoken: '{{ csrf_token }}' },
                            success: function(response) {
                                if(response.status === 'success') {
                                    const newOption = new Option(response.name, response.id, false, false);
                                    $select.find(`option[value="${data.id}"]`).remove();
                                    $select.append(newOption).trigger('change');
                                    const currentSelection = $select.val() || [];
                                    currentSelection.push(response.id);
                                    $select.val(currentSelection).trigger('change');
                                } else {
                                    alert('Error creating new contact.');
                                    const currentSelection = $select.val() || [];
                                    const updatedSelection = currentSelection.filter(item => item !== data.id);
                                    $select.val(updatedSelection).trigger('change');
                                }
                            },
                            error: function() {
                                alert('Error creating new contact.');
                                const currentSelection = $select.val() || [];
                                const updatedSelection = currentSelection.filter(item => item !== data.id);
                                $select.val(updatedSelection).trigger('change');
                            }
                        });
                    }
                });
            }
        });
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // The main function to handle the auto-save
    async function handleStageUpdate(event) {
        const input = event.target;
        const stageId = input.dataset.stageId;
        const fieldName = input.dataset.fieldName;
        let newValue = input.value;

        // Sanitize completion_percentage to prevent 400 errors on empty/invalid input
        if (fieldName === 'completion_percentage') {
            if (newValue === '' || newValue === null) {
                newValue = '0';
            } else if (parseInt(newValue) > 100) {
                newValue = '100';
                input.value = '100'; // Clamp visual input
            } else if (parseInt(newValue) < 0) {
                newValue = '0';
                input.value = '0'; // Clamp visual input
            }
        }
        
        const indicator = document.getElementById(`autosave-indicator-${stageId}`);
        indicator.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';

        const url = "{% url 'update_stage_ajax' 0 %}".replace('0', stageId);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    field_name: fieldName,
                    new_value: newValue
                })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                indicator.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                
                // Update actual date input if the backend auto-filled or cleared it
                if (data.updated_actual_date !== undefined) {
                    const actualDateInput = document.querySelector(`input[name="actual_date_${stageId}"]`);
                    if (actualDateInput) {
                        actualDateInput.value = data.updated_actual_date;
                    }
                }
            } else {
                indicator.innerHTML = `<i class="fas fa-times-circle text-danger" title="${data.message || 'Unknown error'}"></i>`;
                alert(`Error saving stage: ${data.message}`);
            }

        } catch (error) {
            indicator.innerHTML = `<i class="fas fa-times-circle text-danger" title="${error}"></i>`;
            alert('An unexpected network error occurred.');
        }

        // Clear the indicator after a few seconds
        setTimeout(() => {
            indicator.innerHTML = '';
        }, 3000);
    }

    // Attach the event listener to all designated input fields
    const autosaveInputs = document.querySelectorAll('.autosave-input');
    autosaveInputs.forEach(input => {
        input.addEventListener('change', handleStageUpdate);

        // Prevent form submission on Enter key
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                input.blur(); // This triggers the change event handler defined above
            }
        });
    });

    // Handle status changes to update percentage behavior
    function handleStatusChangeForPercentage(event) {
        const statusSelect = event.target;
        const stageId = statusSelect.dataset.stageId;
        const status = statusSelect.value;
        const percentInput = document.querySelector(`input[name="completion_percentage_${stageId}"]`);
        const progressBar = percentInput.closest('td').querySelector('.progress-bar');
        
        if (!percentInput) return;

        // 1. If the stage inprogress then only user should be allowed to add %.
        if (status === 'In Progress') {
            percentInput.disabled = false;
        } else {
            percentInput.disabled = true;
        }

        let newPercent = null;
        // 2. If user selected it as completed, then by default progress bar becomes 100%.
        if (status === 'Completed') {
            newPercent = 100;
        } else if (status === 'Not started') {
            newPercent = 0;
        }

        if (newPercent !== null && percentInput.value != newPercent) {
            percentInput.value = newPercent;
            if (progressBar) {
                progressBar.style.width = newPercent + '%';
                progressBar.setAttribute('aria-valuenow', newPercent);
            }
            // Trigger autosave for the percentage input
            percentInput.dispatchEvent(new Event('change'));
        }
    }

    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', handleStatusChangeForPercentage);
    });

    // Update progress bar visually on input for completion percentage
    document.addEventListener('input', function(event) {
        if (event.target.classList.contains('autosave-input') && event.target.dataset.fieldName === 'completion_percentage') {
            const val = event.target.value;
            const progressBar = event.target.closest('td').querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = val + '%';
                progressBar.setAttribute('aria-valuenow', val);
            }
        }
    });

    // New script to scroll to the push-pull contents section on load
    if (window.location.hash === '#push-pull-contents') {
        const targetElement = document.getElementById('push-pull-contents');
        if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Scroll notes feed to bottom on load
    const notesFeed = document.querySelector('.project-notes-feed');
    if (notesFeed) {
        notesFeed.scrollTop = notesFeed.scrollHeight;
    }

    // --- Push-Pull Content Autosave Logic ---
    window.handleUpdateAutosave = async function(updateId, field, value) {
        const indicator = document.getElementById(`update-indicator-${updateId}`);
        if(indicator) indicator.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';

        const url = "{% url 'update_project_update_ajax' %}";

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    id: updateId,
                    field: field,
                    value: value
                })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                if(indicator) indicator.innerHTML = '<i class="fas fa-check text-success small"></i>';
                setTimeout(() => { if(indicator) indicator.innerHTML = ''; }, 2000);
            } else {
                if(indicator) indicator.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                console.error('Autosave error:', data.message);
            }
        } catch (error) {
            if(indicator) indicator.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
            console.error('Autosave network error:', error);
        }
    };

    document.querySelectorAll('.autosave-update-input').forEach(input => {
        input.addEventListener('change', function(e) {
            handleUpdateAutosave(this.dataset.id, this.dataset.field, this.value);
        });
    });

    // Handle AJAX remark submission
    document.querySelectorAll('.ajax-remark-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const updateId = this.dataset.updateId;
            const container = document.getElementById(`remarks-container-${updateId}`);
            const textarea = this.querySelector('textarea[name="remark_text"]');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Disable button
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const formData = new FormData(this);

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const newRemarkHtml = `
                        <div class="note-card">
                            <div class="note-header">
                                <div class="d-flex align-items-center">
                                    <div class="note-avatar-small">${data.remark.initials}</div>
                                    <span class="note-author">${data.remark.user}</span>
                                </div>
                                <span class="note-time"><i class="far fa-clock me-1"></i>${data.remark.date}</span>
                            </div>
                            <div class="note-content">${data.remark.text.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    
                    const noRemarksDiv = container.querySelector('.text-center.text-muted');
                    if (noRemarksDiv) {
                        noRemarksDiv.remove();
                    }

                    container.insertAdjacentHTML('beforeend', newRemarkHtml);
                    container.scrollTop = container.scrollHeight;
                    textarea.value = '';
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    });
});
</script>
{% endblock %}