{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}{{ project.code }} | Project Tracker{% endblock %}

{% block extra_css %}
<style>
    /* Add styles for our new autosave indicator */
    .autosave-indicator {
        display: inline-block;
        width: 20px; /* Reserve space */
        text-align: center;
        margin-right: 5px;
    }

    /* Style for stages marked as "Not Applicable" */
    .stage-not-applicable {
        background-color: #f8f9fa !important;
        opacity: 0.65;
    }
    .stage-not-applicable td,
    .stage-not-applicable strong {
        text-decoration: line-through;
        color: #6c757d !important;
    }

    /* Styles for table icons to match the timeline component */
    .table-status-icon {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 0.7rem;
        margin-right: 10px;
        vertical-align: middle;
        flex-shrink: 0;
    }
    .table-status-icon.status-completed { background-color: var(--success); }
    .table-status-icon.status-in-progress { background-color: var(--warning); color: #000; }
    .table-status-icon.status-hold { background-color: var(--danger); }
    .table-status-icon.status-not-applicable { background-color: var(--gray); }
    .table-status-icon.status-not-started { background-color: transparent; border: 2px solid #adb5bd; }


    .remark-item {
    display: flex;
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}
.remark-avatar {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--secondary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 1rem;
}
.remark-content {
    flex-grow: 1;
}
.remark-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.25rem;
}
.remark-author {
    font-size: 0.9rem;
    color: var(--dark);
}
.remark-timestamp {
    font-size: 0.75rem;
    color: var(--gray);
}
.remark-text {
    font-size: 0.95rem;
    color: #333;
}

    /* Styles for the Timeline from your preferred version */
    .roadmap { display: flex; position: relative; padding: 0 5px; margin-top: 30px; margin-bottom: 70px; height: 80px; }
    .roadmap-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; flex: 1; text-align: center; }
    .roadmap-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 0 0 4px #f5f7fb; position: relative; z-index: 2; flex-shrink: 0; transition: all 0.3s ease; }
    .roadmap-step:hover .roadmap-circle { transform: scale(1.1); }
    .roadmap-label { font-weight: 500; font-size: 0.8rem; color: #1b263b; margin-top: 10px; height: 50px; display: flex; align-items: center; }
    .roadmap-line { position: absolute; top: 18px; left: 0; right: 0; height: 4px; background-color: #dee2e6; z-index: 1; }
    .roadmap-progress { position: absolute; top: 18px; left: 0; height: 4px; background-color: #28a745; z-index: 2; transition: width 0.4s ease; }
    
    .status-Completed { background-color: var(--success); color: white; } 
    .status-InProgress { background-color: var(--warning); color: black; } 
    .status-Notstarted { background-color: #adb5bd; color: white; } 
    .status-Hold { background-color: var(--danger); color: white; } 
    .status-NotApplicable { background-color: var(--gray); color: white; }

    /* Styles for the Update Feed from the polished lower section */
    .bg-danger-soft { background-color: rgba(220, 53, 69, 0.1); }
    .bg-warning-soft { background-color: rgba(255, 193, 7, 0.1); }
    .bg-info-soft { background-color: rgba(13, 202, 240, 0.1); }
    .bg-success-soft { background-color: rgba(25, 135, 84, 0.1); }

    /* New style for remark items */
    .remark-box {
        background-color: #f8f9fa;
        border-left: 3px solid #0d6efd;
        padding: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}


{% block content %}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="page-title">{{ project.code }} - {{ project.customer_name }}</h1>
            <p class="page-subtitle">{{project.segment_con.name|default:'No Segment'}}</p>
        </div>
        <div>
            <a href="{% url 'tracker_edit_project' project.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-2"></i>Edit Project
            </a>
        </div>
    </div>
    
    <div class="card mb-4"> {# This is the main card for consolidated details #}
        <div class="card-body">
            <div class="row align-items-center mb-3">
                <div class="col-md-4 border-end">
                    <h6 class="text-muted">Project Value</h6>
                    <h4 class="card-title">₹{{ project.value|intcomma }}</h4>
                </div>
                <div class="col-md-4 border-end">
                    <h6 class="text-muted">SO Punch Date</h6>
                    <h4 class="card-title">{{ project.so_punch_date|date:"M d, Y" }}</h4>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">PACe</h6>
                    <h4 class="card-title">{{ project.pace.name|default:'N/A' }}</h4>
                </div>
            </div>
            <hr>
            <div class="progress-wrapper mt-3">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Overall Completion</span>
                    <span class="text-primary fw-bold">{{ completion_percentage }}%</span>
                </div>
                <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-primary" role="progressbar"
                         style="width: {{ completion_percentage }}%;"
                         aria-valuenow="{{ completion_percentage }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title mb-0"><i class="fas fa-cogs"></i>Automation Timeline</h5></div>
            <div class="card-body">
                <div class="roadmap">
                    <div class="roadmap-line"></div>
                    <div class="roadmap-progress" style="width: {{ timeline_progress_auto }}%;"></div>
                    {% for stage in automation_stages %}
                        {% with status=stage.status|default:"Not started" %}
                        <div class="roadmap-step">
                            <div class="roadmap-circle status-{{ status|cut:' '|capfirst }}" data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="top" title="<strong>{{ stage.name }}</strong><br>Status: {{ status }}<br>{% if stage.planned_date %}Planned: {{ stage.planned_date|date:'M d, Y' }}{% endif %}<br>{% if stage.actual_date %}Actual: {{ stage.actual_date|date:'M d, Y' }}{% endif %}">
                                {% if status == "Completed" %}<i class="fas fa-check"></i>
                                {% elif status == "In Progress" %}<i class="fas fa-spinner fa-spin"></i>
                                {% elif status == "Hold" %}<i class="fas fa-pause"></i>
                                {% elif status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                {% else %}<i class="far fa-circle"></i>
                                {% endif %}
                            </div>
                            <div class="roadmap-label">{{ stage.name }}</div>
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title mb-0"><i class="fas fa-gamepad"></i>Emulation Timeline</h5></div>
            <div class="card-body">
                <div class="roadmap">
                    <div class="roadmap-line"></div>
                    <div class="roadmap-progress" style="width: {{ timeline_progress_emu }}%;"></div>
                    {% for stage in emulation_stages %}
                        {% with status=stage.status|default:"Not started" %}
                        <div class="roadmap-step">
                            <div class="roadmap-circle status-{{ status|cut:' '|capfirst }}" data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="top" title="<strong>{{ stage.name }}</strong><br>Status: {{ status }}<br>{% if stage.planned_date %}Planned: {{ stage.planned_date|date:'M d, Y' }}{% endif %}<br>{% if stage.actual_date %}Actual: {{ stage.actual_date|date:'M d, Y' }}{% endif %}">
                                {% if status == "Completed" %}<i class="fas fa-check"></i>
                                {% elif status == "In Progress" %}<i class="fas fa-spinner fa-spin"></i>
                                {% elif status == "Hold" %}<i class="fas fa-pause"></i>
                                {% elif status == "Not Applicable" %}<i class="fas fa-ban"></i>
                                {% else %}<i class="far fa-circle"></i>
                                {% endif %}
                            </div>
                            <div class="roadmap-label">{{ stage.name }}</div>
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="stageTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab != 'emulation' %}active{% endif %}" id="automation-tab" data-bs-toggle="tab" data-bs-target="#automation-content" type="button" role="tab"><i class="fas fa-cogs me-2"></i>Automation</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab == 'emulation' %}active{% endif %}" id="emulation-tab" data-bs-toggle="tab" data-bs-target="#emulation-content" type="button" role="tab"><i class="fas fa-gamepad me-2"></i>Emulation</button></li>
        </ul>
        <div class="tab-content" id="stageTabsContent">
            <div class="tab-pane fade {% if request.GET.active_tab != 'emulation' %}show active{% endif %}" id="automation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="automationStagesForm">
                    {% csrf_token %}<input type="hidden" name="active_tab" value="automation">
                    <div class="d-flex justify-content-end align-items-center mb-3">

                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#allRemarksModalAutomation">
                                <i class="fas fa-comments me-1"></i> View All Remarks
                            </button>

                        <button type="submit" name="save_all_automation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Automation</button>
                    </div>
                    <div class="table-responsive"><table class="table table-bordered table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width:20%">Stage</th><th style="width:15%">Planned Finish Date</th><th style="width:20%">Status</th><th style="width:15%">Start Date</th><th style="width:15%">Finish Date</th><th style="width:15%">Actions</th></tr></thead><tbody>
                        {% for stage in automation_stages %}
                        <tr class="{% if stage.status == 'Not Applicable' %}stage-not-applicable{% endif %}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="table-status-icon status-{{ stage.status|slugify }}">
                                        {% if stage.status == 'Completed' %}<i class="fas fa-check"></i>
                                        {% elif stage.status == 'In Progress' %}<i class="fas fa-ellipsis-h"></i>
                                        {% elif stage.status == 'Hold' %}<i class="fas fa-pause"></i>
                                        {% elif stage.status == 'Not Applicable' %}<i class="fas fa-ban"></i>
                                        {% else %}{% comment %} Empty for Not Started to show the outline circle {% endcomment %}
                                        {% endif %}
                                    </div>
                                    <strong>{{ stage.name }}</strong>
                                </div>
                            </td>
                            <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                            <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select autosave-input" data-stage-id="{{ stage.id }}" data-field-name="status">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                            <td><input type="date" name="planned_start_date_{{ stage.id }}" class="form-control form-control-sm autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_start_date" value="{{ stage.planned_start_date|date:'Y-m-d' }}"></td>
                            <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="actual_date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="autosave-indicator" id="autosave-indicator-{{ stage.id }}"></span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
                                        <ul class="dropdown-menu">
                                            <li><button type="submit" class="dropdown-item" name="stage_id" value="{{ stage.id }}"><i class="fas fa-save me-2"></i>Save Stage</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-2"></i>History</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus-circle me-2"></i>Add Remark</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye me-2"></i>View Remarks</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody></table></div>
                </form>
            </div>
            <div class="tab-pane fade {% if request.GET.active_tab == 'emulation' %}show active{% endif %}" id="emulation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="emulationStagesForm">
                    {% csrf_token %}<input type="hidden" name="active_tab" value="emulation">
                    <div class="d-flex justify-content-end align-items-center mb-3">

                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#allRemarksModalEmulation">
                                <i class="fas fa-comments me-1"></i> View All Remarks
                            </button>

                        <button type="submit" name="save_all_emulation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Emulation</button>
                    </div>
                    <div class="table-responsive"><table class="table table-bordered table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width:20%">Stage</th><th style="width:15%">Planned Finish Date</th><th style="width:20%">Status</th><th style="width:15%">Start Date</th><th style="width:15%">Finish Date</th><th style="width:15%">Actions</th></tr></thead><tbody>
                        {% for stage in emulation_stages %}
                        <tr class="{% if stage.status == 'Not Applicable' %}stage-not-applicable{% endif %}">
                           <td>
                                <div class="d-flex align-items-center">
                                    <div class="table-status-icon status-{{ stage.status|slugify }}">
                                        {% if stage.status == 'Completed' %}<i class="fas fa-check"></i>
                                        {% elif stage.status == 'In Progress' %}<i class="fas fa-ellipsis-h"></i>
                                        {% elif stage.status == 'Hold' %}<i class="fas fa-pause"></i>
                                        {% elif stage.status == 'Not Applicable' %}<i class="fas fa-ban"></i>
                                        {% else %}{% comment %} Empty for Not Started to show the outline circle {% endcomment %}
                                        {% endif %}
                                    </div>
                                    <strong>{{ stage.name }}</strong>
                                </div>
                            </td>
                            <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                            <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select autosave-input" data-stage-id="{{ stage.id }}" data-field-name="status">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                            <td><input type="date" name="planned_start_date_{{ stage.id }}" class="form-control form-control-sm autosave-input" data-stage-id="{{ stage.id }}" data-field-name="planned_start_date" value="{{ stage.planned_start_date|date:'Y-m-d' }}"></td>
                            <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date autosave-input" data-stage-id="{{ stage.id }}" data-field-name="actual_date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="autosave-indicator" id="autosave-indicator-{{ stage.id }}"></span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
                                        <ul class="dropdown-menu">
                                            <li><button type="submit" class="dropdown-item" name="stage_id" value="{{ stage.id }}"><i class="fas fa-save me-2"></i>Save Stage</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-2"></i>History</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus-circle me-2"></i>Add Remark</button></li>
                                            <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye me-2"></i>View Remarks</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody></table></div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="row mt-4">
    <div class="col-lg-6 d-flex">
        <div class="card w-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-info-circle me-2"></i>Project Summary</h5></div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-muted">Current Status</h6>
                    <div class="d-flex align-items-center mt-1">
                        <span class="badge fs-6 {% if overall_status == 'Completed' %}bg-success{% elif overall_status == 'In Progress' %}bg-warning text-dark{% elif overall_status == 'Hold' %}bg-danger{% else %}bg-secondary{% endif %} me-3">{{ overall_status }}</span>
                        {% if last_update_time %}<small class="text-muted"><i class="far fa-clock me-1"></i>Last updated: {{ last_update_time|date:"M d, Y" }}</small>{% endif %}
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-6 border-end">
                        <h6 class="text-muted">Next Automation Milestone</h6>
                        {% if next_automation_milestone %}
                            <strong>{{ next_automation_milestone.name }}</strong>
                            <div class="text-muted small mt-1">Planned: {{ next_automation_milestone.planned_date|date:"M d, Y" }}</div>
                        {% else %}
                            <p class="text-muted mb-0 small">All automation stages complete.</p>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted">Next Emulation Milestone</h6>
                        {% if next_emulation_milestone %}
                            <strong>{{ next_emulation_milestone.name }}</strong>
                            <div class="text-muted small mt-1">Planned: {{ next_emulation_milestone.planned_date|date:"M d, Y" }}</div>
                        {% else %}
                            <p class="text-muted mb-0 small">All emulation stages complete.</p>
                        {% endif %}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6 border-end">

                         <h6 class="text-muted">Overall OTIF % (All Stages)</h6>
                         <p class="h5 mb-0">
                            {% if overall_otif_percentage is not None %}
                                {{ overall_otif_percentage|floatformat:1 }}%
                            {% else %}
                                <span class="text-muted small">No completed stages yet</span>
                            {% endif %}
                         </p>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted">Project Delivery Status (Handover)</h6>
                        <p class="mb-0">
                            {% if project_otif == 101 %}
                                <span class="badge bg-success fs-6">Before Time In Full</span>
                            {% elif project_otif == 100 %}
                                <span class="badge bg-primary fs-6">On Time In Full</span>
                            {% elif project_otif == 0 %}
                                <span class="badge bg-danger fs-6">Delayed</span>
                            {% else %}
                                <span class="text-muted small">Pending Completion</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6 border-end">

                         <h6 class="text-muted">Automation Schedule</h6>
                         {% with schedule_status=automation_schedule_status %}
                            {% if schedule_status is not None %}{% if schedule_status > 0 %}<span class="badge bg-danger">Delayed by {{ schedule_status }} day{{ schedule_status|pluralize }}</span>{% elif schedule_status < 0 %}<span class="badge bg-success">Ahead by {{ schedule_status|abs }} day{{ schedule_status|abs|pluralize }}</span>{% else %}<span class="badge bg-primary">On Time</span>{% endif %}{% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                         {% endwith %}
                    </div>
                     <div class="col-6">
                        <h6 class="text-muted">Emulation Schedule</h6>
                        {% with schedule_status=emulation_schedule_status %}
                           {% if schedule_status is not None %}{% if schedule_status > 0 %}<span class="badge bg-danger">Delayed by {{ schedule_status }} day{{ schedule_status|pluralize }}</span>{% elif schedule_status < 0 %}<span class="badge bg-success">Ahead by {{ schedule_status|abs }} day{{ schedule_status|abs|pluralize }}</span>{% else %}<span class="badge bg-primary">On Time</span>{% endif %}{% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                        {% endwith %}
                   </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 d-flex">
        <div class="card w-100">
            <div class="card-header">
                <h5 class="card-header-title"><i class="fas fa-history me-2"></i>Recent Activity</h5>
                <a href="{% url 'tracker_project_activity' project.id %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_activity %}
                    {% for log in recent_activity %}
                    <div class="d-flex mb-3">
                        <div class="me-3">
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; flex-shrink: 0;">
                                <i class="fas fa-{% if log.field_name == 'status' %}exchange-alt{% else %}calendar-alt{% endif %} text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <p class="mb-0 lh-sm">
                                <strong>{{ log.stage.name }}</strong> {{ log.field_name }} updated from '{{ log.old_value|default:"-" }}' to '{{ log.new_value|default:"-" }}'.
                            </p>
                            <small class="text-muted">{{ log.changed_at|naturaltime }} by {{ log.changed_by|default:"System" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-4"><i class="fas fa-info-circle fa-2x text-muted mb-3"></i><p class="text-muted">No recent activity</p></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card" id="push-pull-contents">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-bullhorn me-2"></i>Push-Pull Contents</h5></div>
            <div class="card-body">
                <form action="{% url 'add_project_update' project.id %}" method="post" class="mb-4 p-3 bg-light rounded">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="update_text" class="form-label fw-bold">Add a New Push/Pull Content</label>
                        <textarea name="update_text" id="update_text" rows="3" class="form-control" placeholder="Share a new update on the project's progress, risks, or actions needed..." required></textarea>
                    </div>
                    <div class="row g-3 align-items-center">
                        <div class="col-md-3">
                            <label for="push_pull_type" class="form-label small mb-0">Type</label>
                            <select name="push_pull_type" id="push_pull_type" class="form-select form-select-sm">
                                <option value="Push">Push Content</option>
                                <option value="Pull">Pull Content</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="who_contact" class="form-label small mb-0">Who</label>
                            <input class="form-control form-control-sm" list="contact-persons-list" id="who_contact" name="who_contact" placeholder="Type or select a person">
                            <datalist id="contact-persons-list">
                                {% for person in contact_persons %}
                                    <option value="{{ person.name }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="col-md-3">
                            <label for="eta_date" class="form-label small mb-0">ETA</label>
                            <input type="date" name="eta_date" id="eta_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save</button>
                        </div>
                    </div>
                </form>
                <hr>
                <h5 class="mt-4">Push Pull Content Summary</h5>
                <div class="update-feed mt-3 accordion" id="updateAccordion">
                    {% for update in updates %}
                        {% include 'tracker/partials/project_update_item.html' with update=update user=user contact_persons=contact_persons %}
                    {% empty %}
                        <p class="text-muted text-center py-3">No push pull contents have been added yet.</p>
                    {% endfor %}
                </div>
                {% if updates_count > 5 %}
                <div class="text-center mt-3">
                    <a href="{% url 'all_project_updates' project.id %}">View all {{ updates_count }} updates...</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


{% for stage in automation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}
{% for stage in emulation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}
{% include 'tracker/partials/project_update_modals.html' with updates=updates contact_persons=contact_persons %}
{% include 'tracker/partials/all_remarks_modals.html' %}


{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl, { html: true, sanitize: false }); });

    const rows = document.querySelectorAll('#automationStagesForm tbody tr, #emulationStagesForm tbody tr');
    const today = new Date().toISOString().split('T')[0];

    rows.forEach(row => {
        const plannedStartInput = row.querySelector('.autosave-input[data-field-name="planned_start_date"]');
        const plannedFinishInput = row.querySelector('.planned-date');
        const statusSelect = row.querySelector('.status-select');
        const actualFinishInput = row.querySelector('.actual-date');

        if (!plannedStartInput || !plannedFinishInput || !statusSelect || !actualFinishInput) return;

        const updateRowState = () => {
            const isNotApplicable = statusSelect.value === 'Not Applicable';

            // Toggle visual style for the entire row
            row.classList.toggle('stage-not-applicable', isNotApplicable);

            // Disable all date inputs if status is N/A
            plannedStartInput.disabled = isNotApplicable;
            plannedFinishInput.disabled = isNotApplicable;
            actualFinishInput.disabled = isNotApplicable;

            // If N/A, clear dates, ensure all status options are available, and then exit.
            if (isNotApplicable) {
                statusSelect.querySelectorAll('option').forEach(opt => opt.disabled = false);
                // Clear date inputs for N/A stages
                plannedStartInput.value = '';
                plannedFinishInput.value = '';
                actualFinishInput.value = '';
                return;
            }

            // --- If NOT N/A, proceed with the standard logic ---
            const hasPlannedFinishDate = plannedFinishInput.value;
            const statusOptions = statusSelect.querySelectorAll('option');

            if (hasPlannedFinishDate) {
                // If there's a date, enable all options.
                statusOptions.forEach(opt => opt.disabled = false);
            } else {
                // If there's NO date, disable all options except for "Not Applicable".
                statusOptions.forEach(opt => {
                    opt.disabled = (opt.value !== 'Not Applicable');
                });
                
                // If the currently selected value is now disabled, reset it to "Not started"
                // (assuming "Not started" is the default for non-applicable states without a planned date)
                if (statusSelect.value !== 'Not Applicable' && statusSelect.value !== 'Not started') {
                    statusSelect.value = 'Not started';
                }
            }
            
            // This logic depends on the current status, which might have just been reset.
            const isCompleted = statusSelect.value === 'Completed';
            actualFinishInput.disabled = !isCompleted;
            if (!isCompleted) {
                actualFinishInput.value = '';
            }
        };
        
        const validateActualDate = () => {
            if (actualFinishInput.value && actualFinishInput.value > today) { // Check if value exists before comparing
                alert("Actual Finish Date cannot be in the future.");
                actualFinishInput.value = '';
            }
        };

        // Initial setup and event listeners
        updateRowState();
        plannedStartInput.addEventListener('change', updateRowState); // Also trigger on planned start date change
        plannedFinishInput.addEventListener('change', updateRowState);
        statusSelect.addEventListener('change', updateRowState);
        actualFinishInput.addEventListener('change', validateActualDate);
    });

    // Logic for edit modals (unchanged)
    const editModals = document.querySelectorAll('[id^="editUpdateModal"]');
    editModals.forEach(modal => {
        const categorySelect = modal.querySelector('select[name="update_category"]');
        const mitigationContainer = modal.querySelector('[id^="mitigation-plan-container-"]');
        if (categorySelect && mitigationContainer) {
            categorySelect.addEventListener('change', function() {
                if (this.value === 'Risk') { mitigationContainer.classList.remove('d-none'); } else { mitigationContainer.classList.add('d-none'); }
            });
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // The main function to handle the auto-save
    async function handleStageUpdate(event) {
        const input = event.target;
        const stageId = input.dataset.stageId;
        const fieldName = input.dataset.fieldName;
        const newValue = input.value;
        
        const indicator = document.getElementById(`autosave-indicator-${stageId}`);
        indicator.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';

        // ✅ CORRECTED: Generate the URL dynamically using Django's url template tag
        const url = "{% url 'update_stage_ajax' 0 %}".replace('0', stageId);

        try {
            const response = await fetch(url, { // Use the dynamically generated URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    field_name: fieldName,
                    new_value: newValue
                })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                indicator.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
            } else {
                indicator.innerHTML = `<i class="fas fa-times-circle text-danger" title="${data.message || 'Unknown error'}"></i>`;
                alert(`Error saving stage: ${data.message}`);
            }

        } catch (error) {
            indicator.innerHTML = `<i class="fas fa-times-circle text-danger" title="${error}"></i>`;
            alert('An unexpected network error occurred.');
        }

        // Clear the indicator after a few seconds
        setTimeout(() => {
            indicator.innerHTML = '';
        }, 3000);
    }

    // Attach the event listener to all designated input fields
    const autosaveInputs = document.querySelectorAll('.autosave-input');
    autosaveInputs.forEach(input => {
        input.addEventListener('change', handleStageUpdate);
    });

    // New script to scroll to the push-pull contents section on load
    if (window.location.hash === '#push-pull-contents') {
        const targetElement = document.getElementById('push-pull-contents');
        if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });
        }
    }
});
</script>
{% endblock %}