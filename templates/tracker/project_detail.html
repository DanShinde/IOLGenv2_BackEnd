{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}{{ project.code }} | Project Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="page-title">{{ project.code }} - {{ project.customer_name }}</h1>
            <p class="page-subtitle">{{project.segment_con.name}}</p>
        </div>
        <span class="badge bg-primary fs-6 py-2 px-3">Project</span>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Project Value</h6>
                            <h4 class="card-title">â‚¹{{ project.value|floatformat:2 }}</h4>
                        </div>
                        <div class="text-end">
                            <h6 class="text-muted">SO Punch Date</h6>
                            <h4 class="card-title">{{ project.so_punch_date|date:"M d, Y" }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="progress-wrapper">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Completion</span>
                            <span class="text-primary fw-bold">{{ completion_percentage }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ completion_percentage }}%;" aria-valuenow="{{ completion_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="stageTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab != 'emulation' %}active{% endif %}" id="automation-tab" data-bs-toggle="tab" data-bs-target="#automation-content" type="button" role="tab"><i class="fas fa-cogs me-2"></i>Automation</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link {% if request.GET.active_tab == 'emulation' %}active{% endif %}" id="emulation-tab" data-bs-toggle="tab" data-bs-target="#emulation-content" type="button" role="tab"><i class="fas fa-gamepad me-2"></i>Emulation</button></li>
        </ul>
        <div class="tab-content" id="stageTabsContent">
            <div class="tab-pane fade {% if request.GET.active_tab != 'emulation' %}show active{% endif %}" id="automation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="automationStagesForm">
                    {% csrf_token %}
                    <input type="hidden" name="active_tab" value="automation">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-header-title mb-0"><i class="fas fa-tasks"></i>Automation Stages</h5>
                        <button type="submit" name="save_all_automation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Automation</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr><th>Stage</th><th>Planned Date</th><th>Status</th><th>Actual Date</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                {% for stage in automation_stages %}
                                <tr>
                                    <td><strong>{{ stage.name }}</strong></td>
                                    <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                                    <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                                    <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                                    <td><div class="d-flex gap-2 flex-wrap"><button type="submit" class="btn btn-sm btn-success" name="stage_id" value="{{ stage.id }}"><i class="fas fa-check me-1"></i> Save</button><button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-1"></i> History</button><button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus"></i> Add Remark</button><button type="button" class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye"></i> View Remarks</button></div></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="tab-pane fade {% if request.GET.active_tab == 'emulation' %}show active{% endif %}" id="emulation-content" role="tabpanel">
                <form method="POST" action="{% url 'tracker_project_detail' project.id %}" id="emulationStagesForm">
                    {% csrf_token %}
                    <input type="hidden" name="active_tab" value="emulation">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-header-title mb-0"><i class="fas fa-tasks"></i>Emulation Stages</h5>
                        <button type="submit" name="save_all_emulation" value="1" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save All Emulation</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr><th>Stage</th><th>Planned Date</th><th>Status</th><th>Actual Date</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                {% for stage in emulation_stages %}
                                <tr>
                                    <td><strong>{{ stage.name }}</strong></td>
                                    <td><input type="date" name="planned_date_{{ stage.id }}" class="form-control form-control-sm planned-date" value="{{ stage.planned_date|date:'Y-m-d' }}"></td>
                                    <td><select name="status_{{ stage.id }}" class="form-select form-select-sm status-select">{% for val, label in stage.STATUS_CHOICES %}<option value="{{ val }}" {% if stage.status == val %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></td>
                                    <td><input type="date" name="actual_date_{{ stage.id }}" class="form-control form-control-sm actual-date" value="{{ stage.actual_date|date:'Y-m-d' }}"></td>
                                    <td><div class="d-flex gap-2 flex-wrap"><button type="submit" class="btn btn-sm btn-success" name="stage_id" value="{{ stage.id }}"><i class="fas fa-check me-1"></i> Save</button><button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal{{ stage.id }}"><i class="fas fa-history me-1"></i> History</button><button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#addRemarkModal{{ stage.id }}"><i class="fas fa-plus"></i> Add Remark</button><button type="button" class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#viewRemarkModal{{ stage.id }}"><i class="fas fa-eye"></i> View Remarks</button></div></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% for stage in automation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}
{% for stage in emulation_stages %}{% include 'tracker/partials/stage_modals.html' with stage=stage %}{% endfor %}

<div class="row">
    <div class="col-md-6 d-flex">
        <div class="card h-100 w-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-info-circle"></i>Project Summary</h5></div>
            <div class="card-body">
                <h6 class="text-muted">Current Status</h6><div class="d-flex align-items-center mt-2"><span class="badge {% if overall_status == 'Completed' %}bg-success{% elif overall_status == 'In Progress' %}bg-warning text-dark{% elif overall_status == 'Hold' %}bg-danger{% else %}bg-secondary{% endif %} me-3">{{ overall_status }}</span>{% if last_update_time %}<small class="text-muted">Last updated: {{ last_update_time|date:"M d, Y" }}</small>{% endif %}</div>
                <hr class="my-3"><h6 class="text-muted">Next Milestone</h6>{% if next_milestone %}<div><strong>{{ next_milestone.name }}</strong><div class="text-muted small mt-1">Planned on {{ next_milestone.planned_date|date:"M d, Y" }}</div></div>{% else %}<p class="text-muted mb-0">No upcoming milestones</p>{% endif %}
                <hr class="my-3"><h6 class="text-muted">Schedule Status</h6>{% if schedule_status is not None %}{% if schedule_status > 0 %}<span class="badge bg-danger">Delayed by {{ schedule_status }} day{{ schedule_status|pluralize }}</span>{% elif schedule_status < 0 %}<span class="badge bg-success">Ahead by {{ schedule_status|abs }} day{{ schedule_status|abs|pluralize }}</span>{% else %}<span class="badge bg-primary">On Time</span>{% endif %}{% else %}<span class="text-muted">Not enough data to determine</span>{% endif %}
                <hr class="my-3"><h6 class="text-muted">Overall OTIF Performance</h6>{% if otif_percentage is not None %}<span class="badge bg-info text-white">{{ otif_percentage }}% On Time In Full</span>{% else %}<p class="text-muted">No completed stages to evaluate</p>{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6 d-flex">
        <div class="card h-100 w-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-history"></i>Recent Activity</h5><a href="{% url 'tracker_project_activity' project.id %}" class="btn btn-sm btn-outline-primary">View All</a></div>
            <div class="card-body">{% if recent_activity %}<div class="activity-feed">{% for log in recent_activity %}<div class="activity-item mb-3"><div class="d-flex"><div class="activity-icon bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;"><i class="fas fa-{% if log.field_name == 'status' %}exchange-alt{% else %}calendar-alt{% endif %}"></i></div><div><div class="d-flex justify-content-between"><strong>{{ log.stage.name }} - {{ log.field_name|title }}</strong><small class="text-muted">{{ log.changed_at|timesince }} ago</small></div><div class="d-flex align-items-center mt-1"><span class="text-muted me-2">From:</span><span class="badge bg-light text-dark">{{ log.old_value|default:"-" }}</span><i class="fas fa-arrow-right mx-2 text-muted"></i><span class="text-muted me-2">To:</span><span class="badge bg-primary">{{ log.new_value|default:"-" }}</span></div><small class="text-muted">Changed by {{ log.changed_by|default:"System" }}</small></div></div></div>{% endfor %}</div>{% else %}<div class="text-center py-4"><i class="fas fa-info-circle fa-2x text-muted mb-3"></i><p class="text-muted">No recent activity</p></div>{% endif %}</div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-bullhorn"></i>Project Updates</h5></div>
            <div class="card-body">
                <form action="{% url 'add_project_update' project.id %}" method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3"><label for="update_text" class="form-label fw-bold">New Update</label><textarea name="update_text" id="update_text" rows="3" class="form-control" placeholder="Share a new update on the project's progress..." required></textarea></div>
                    <div class="row align-items-center">
                        <div class="col-md-4"><label for="update_category" class="form-label">Category</label><select name="update_category" id="update_category" class="form-select"><option value="Information">Information</option><option value="Action">Action</option><option value="Risk">Risk</option></select></div>
                        <div class="col-md-4"><div class="form-check mt-4"><input class="form-check-input" type="checkbox" name="needs_review" value="true" id="needs_review"><label class="form-check-label" for="needs_review">Flag for Senior Review</label></div></div>
                        <div class="col-md-4 text-end"><button type="submit" class="btn btn-primary mt-2"><i class="fas fa-plus-circle me-2"></i>Add Update</button></div>
                    </div>
                </form>
                <hr>
                <h5 class="mt-4">Update History</h5>
                <div class="update-feed mt-3">
                    {% for update in updates %}
                        {% include 'tracker/partials/project_update_item.html' with update=update user=user %}
                    {% empty %}
                        <p class="text-muted text-center">No project updates have been added yet.</p>
                    {% endfor %}
                </div>
                {% if updates_count > 5 %}<div class="text-center mt-3"><a href="{% url 'all_project_updates' project.id %}">View all {{ updates_count }} updates...</a></div>{% endif %}
            </div>
        </div>
    </div>
</div>

{% include 'tracker/partials/project_update_modals.html' with updates=updates %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('#automationStagesForm tbody tr, #emulationStagesForm tbody tr'); const today = new Date().toISOString().split('T')[0];
    rows.forEach(row => {
        const pDI = row.querySelector('.planned-date'), sS = row.querySelector('.status-select'), aDI = row.querySelector('.actual-date');
        if (!pDI || !sS || !aDI) return;
        const tF = () => {
            const p = pDI.value, iC = sS.value === 'Completed';
            if (p) { sS.disabled = false; aDI.disabled = !iC; if (!iC) aDI.value = ''; } else { sS.disabled = true; aDI.disabled = true; aDI.value = ''; }
        };
        const vAD = () => { if (aDI.value > today) { alert("Actual date cannot be in the future."); aDI.value = ''; } };
        tF(); pDI.addEventListener('input', tF); sS.addEventListener('change', tF); aDI.addEventListener('change', vAD);
    });
});
</script>

{% endblock %}