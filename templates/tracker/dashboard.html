{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}Dashboard | Project Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title"><i class="fas fa-tachometer-alt me-2"></i>Project Dashboard</h1>
            <p class="page-subtitle">Monitor and manage all your projects in one place</p>
        </div>
        <a href="{% url 'tracker_new_project' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>New Project
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-calendar-alt me-2"></i> {{ selected_period_display }}
                </button>
                <ul class="dropdown-menu">
                    {% for key, value in period_filter_options.items %}
                    <li>
                        <a class="dropdown-item {% if selected_period_key == key %}active{% endif %}" href="?{{ request.GET.urlencode|cut:'period'|cut:'start_date_custom'|cut:'end_date_custom' }}&period={{ key }}">{{ value.0 }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <div class="d-flex align-items-center gap-2">
                <label class="text-muted small">Custom Range:</label>
                <input type="date" name="start_date_custom" class="form-control form-control-sm" value="{{ custom_start_date|default:'' }}">
                <span class="text-muted">to</span>
                <input type="date" name="end_date_custom" class="form-control form-control-sm" value="{{ custom_end_date|default:'' }}">
                <input type="hidden" name="chronic_period" value="{{ selected_chronic_period|default:'1y' }}">
                <button type="submit" class="btn btn-sm btn-secondary">Go</button>
            </div>
        </form>
    </div>
</div>


<div class="row mb-4">
    <div class="col-lg col-md-4 mb-3">
        <div class="metric-card"><div class="metric-icon"><i class="fas fa-project-diagram"></i></div><div class="metric-value">{{ total_projects }}</div><div class="metric-label">Live Projects (in period)</div></div>
    </div>
    <div class="col-lg col-md-4 mb-3">
        <div class="metric-card"><div class="metric-icon"><i class="fas fa-spinner"></i></div><div class="metric-value">{{ active_projects }}</div><div class="metric-label">Active Projects</div></div>
    </div>
    <div class="col-lg col-md-4 mb-3">
        <div class="metric-card"><div class="metric-icon" style="color: #28a745; background: rgba(40, 167, 69, 0.1);"><i class="fas fa-check-double"></i></div><div class="metric-value">{{ department_otif }}%</div><div class="metric-label">Department OTIF %</div></div>
    </div>
    <div class="col-lg col-md-6 mb-3">
        <div class="metric-card"><div class="metric-icon" style="color: #dc3545; background: rgba(220, 53, 69, 0.1);"><i class="fas fa-exclamation-triangle"></i></div><div class="metric-value">{{ delayed_projects }}</div><div class="metric-label">Hold Projects</div></div>
    </div>
    <div class="col-lg col-md-6 mb-3">
        <div class="metric-card"><div class="metric-icon"><i class="fas fa-indian-rupee-sign"></i></div><div class="metric-value">₹{{ total_value|intcomma }}</div><div class="metric-label">Value of Live Projects in Cr.</div></div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-bar"></i>Project Completion (Live in Period)</h5></div>

            
            {# This card-body is now our fixed-height "viewport" with a scrollbar #}
            <div class="card-body" style="height: 450px; overflow-y: auto;">
                
                {# This inner div will grow taller than the viewport if needed #}
                <div id="progressChartContainer" style="position: relative;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-pie"></i>Status Distribution (Live in Period)</h5></div>
            <div class="card-body"><canvas id="statusChart" height="200"></canvas></div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-layer-group"></i>Projects by Segment</h5></div>
            <div class="card-body"><canvas id="segmentChart" height="200"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-header-title"><i class="fas fa-users"></i>Projects by Team Lead</h5></div>
            <div class="card-body"><canvas id="teamLeadChart" height="200"></canvas></div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-header-title"><i class="fas fa-history"></i>Chronic Projects (Open for >)</h5>
                <div class="card-header-actions">
                    <div class="btn-group btn-group-sm">
                        <a href="?{{ request.GET.urlencode|cut:'chronic_period' }}&chronic_period=6m" class="btn {% if selected_chronic_period == '6m' %}btn-primary{% else %}btn-outline-primary{% endif %}">6+ Months</a>
                        <a href="?{{ request.GET.urlencode|cut:'chronic_period' }}&chronic_period=1y" class="btn {% if selected_chronic_period == '1y' %}btn-primary{% else %}btn-outline-primary{% endif %}">1+ Year</a>
                        <a href="?{{ request.GET.urlencode|cut:'chronic_period' }}&chronic_period=2y" class="btn {% if selected_chronic_period == '2y' %}btn-primary{% else %}btn-outline-primary{% endif %}">2+ Years</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom table-striped">

                        <thead class="table-light">
                            <tr>
                                <th>Project Code</th>
                                <th>Customer</th>
                                <th>Age</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                            {# NEW: Row for filter inputs #}
                            <tr class="table-filter-row">
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Code..." onkeyup="filterDashboardTables(this)"></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Customer..." onkeyup="filterDashboardTables(this)"></th>
                                <th></th> {# No filter for Age #}
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Status..." onkeyup="filterDashboardTables(this)"></th>
                                <th></th> {# No filter for Progress #}
                                <th></th> {# No filter for Actions #}
                            </tr>
                        </thead>

                        <tbody>
                            {% for project in chronic_projects %}
                            <tr>
                                <td><strong><a href="{% url 'tracker_project_detail' project.id %}">{{ project.code }}</a></strong></td><td>{{ project.customer_name }}</td><td>{{ project.so_punch_date|timesince }}</td><td><span class="status-badge bg-{{ project.get_overall_status|slugify }}">{{ project.get_overall_status }}</span></td>
                                <td><div class="d-flex align-items-center"><div class="progress flex-grow-1 me-2" style="height: 8px;"><div class="progress-bar bg-danger" role="progressbar" style="width: {{ project.get_completion_percentage }}%"></div></div><small>{{ project.get_completion_percentage }}%</small></div></td>
                                <td><a href="{% url 'tracker_project_detail' project.id %}" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-eye"></i></a></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center py-4">No chronic projects found for this period.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-header-title"><i class="fas fa-list"></i>Recently Created Projects</h5>
                <a href="{% url 'tracker_index' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom table-striped">

                        <thead class="table-light">
                            <tr>
                                <th>Project Code</th>
                                <th>Customer</th>
                                <th>Segment</th>
                                <th>Value in Cr.</th>
                                <th>SO Punch Date</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                            {# NEW: Row for filter inputs #}
                            <tr class="table-filter-row">
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Code..." onkeyup="filterDashboardTables(this)"></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Customer..." onkeyup="filterDashboardTables(this)"></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Segment..." onkeyup="filterDashboardTables(this)"></th>
                                <th></th> {# No filter for Value #}
                                <th></th> {# No filter for Date #}
                                <th><input type="text" class="form-control form-control-sm" placeholder="Filter Status..." onkeyup="filterDashboardTables(this)"></th>
                                <th></th> {# No filter for Progress #}
                                <th></th> {# No filter for Actions #}
                            </tr>
                        </thead>

                        <tbody>
                            {% for project in recent_projects %}
                            <tr>
                                <td><strong>{{ project.code }}</strong></td><td>{{ project.customer_name }}</td><td>{{ project.segment_con.name|default:'N/A' }}</td><td>₹{{ project.value|floatformat:2|intcomma }}</td><td>{{ project.so_punch_date|date:"M d, Y" }}</td><td><span class="status-badge bg-{{ project.get_overall_status|slugify }}">{{ project.get_overall_status }}</span></td>
                                <td><div class="d-flex align-items-center"><div class="progress flex-grow-1 me-2" style="height: 6px;"><div class="progress-bar" role="progressbar" style="width: {{ project.get_completion_percentage }}%" ></div></div><small>{{ project.get_completion_percentage }}%</small></div></td>
                                <td><a href="{% url 'tracker_project_detail' project.id %}" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-eye"></i></a><a href="{% url 'tracker_delete_project' project.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-trash"></i></a></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center py-4">No recent projects found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
// --- Table Filtering Function ---
function filterDashboardTables(input) {
    const filterValue = input.value.toLowerCase();
    const table = input.closest('table');
    const columnIndex = input.closest('th').cellIndex;
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        // Skip "No projects found" rows
        if (row.cells.length <= 1) return;
        
        const cell = row.cells[columnIndex];
        if (cell) {
            const text = cell.textContent || cell.innerText;
            row.style.display = text.toLowerCase().indexOf(filterValue) > -1 ? '' : 'none';
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    Chart.register(ChartDataLabels);


    // --- SCRIPT FOR SCROLLABLE PROGRESS CHART ---
    const progressCtx = document.getElementById('progressChart');
    const progressChartContainer = document.getElementById('progressChartContainer');

    // 1. Define the fixed height for our viewing area and for each bar
    const viewportHeight = 420; // The height of our visible chart area in pixels
    const heightPerProject = 40; // The desired height for each project's bar

    // 2. Calculate the total height the chart CONTENT needs to be
    const projectsCount = {{ labels|length }};
    const totalContentHeight = projectsCount * heightPerProject;

    // 3. Determine the final height for the chart's container
    // It will be AT LEAST the height of the viewport, or taller if there are many projects.
    const finalHeight = Math.max(viewportHeight, totalContentHeight);
    
    // 4. Apply the calculated height to the inner container
    progressChartContainer.style.height = `${finalHeight}px`;

    // 5. Create the chart
    new Chart(progressCtx, {
        type: 'bar',
        data: { 
            labels: [{% for label in labels %}"{{ label|escapejs }}",{% endfor %}], 
            datasets: [ 
                { label: 'On Track (>= 80%)', data: {{ on_track_data|safe }}, backgroundColor: 'rgba(67, 97, 238, 0.7)', borderWidth: 1 }, 
                { label: 'At Risk (40-79%)', data: {{ at_risk_data|safe }}, backgroundColor: 'rgba(255, 193, 7, 0.7)', borderWidth: 1 }, 
                { label: 'Delayed (< 40%)', data: {{ delayed_data|safe }}, backgroundColor: 'rgba(220, 53, 69, 0.7)', borderWidth: 1 } 
            ] 
        },
        options: { 
            indexAxis: 'y', 
            responsive: true,
            maintainAspectRatio: false, // This is crucial to allow resizing
            plugins: { 
                legend: { display: true, position: 'top' }, 
                datalabels: { color: '#ffffff', font: { weight: 'bold' }, formatter: function(value, context) { return value > 0 ? value + '%' : null; } } 
            }, 
            scales: { 
                x: { stacked: true, min: 0, max: 100, title: { display: true, text: 'Completion %' } }, 
                y: { stacked: true } 
            } 
        }
    });

    // --- Status Chart (This part is corrected) ---
    const statusCanvas = document.getElementById('statusChart');

    if (statusCanvas && {{ status_data|safe }}.length > 0) {
        // ✅ CORRECTED: Changed getContext('d') to getContext('2d')
        const statusCtx = statusCanvas.getContext('2d');
        new Chart(statusCtx, {
            type: 'pie',
            data: { 
                labels: [{% for label in status_labels %}"{{ label|escapejs }}",{% endfor %}], 
                datasets: [{ 
                    label: 'Project Status', 
                    data: {{ status_data|safe }}, 
                    backgroundColor: [{% for color in status_colors %}"{{ color|escapejs }}",{% endfor %}]
                }] 
            },
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { position: 'top' } 
                } 
            }
        });
    }

    // --- Segment Chart ---
    const segmentCtx = document.getElementById('segmentChart').getContext('2d');
    new Chart(segmentCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for label in segment_labels %}"{{ label|escapejs }}",{% endfor %}],
            datasets: [{
                data: {{ segment_data|safe }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'right' } }
        }
    });

    // --- Team Lead Chart ---
    const teamLeadCtx = document.getElementById('teamLeadChart').getContext('2d');
    new Chart(teamLeadCtx, {
        type: 'bar',
        data: {
            labels: [{% for label in team_lead_labels %}"{{ label|escapejs }}",{% endfor %}],
            datasets: [{
                label: 'Projects',
                data: {{ team_lead_data|safe }},
                backgroundColor: '#36b9cc',
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
});
</script>
{% endblock %}