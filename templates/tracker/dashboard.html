{% extends 'tracker/base.html' %}
{% load custom_tags %}

{% block title %}Dashboard | Project Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title"><i class="fas fa-tachometer-alt me-2"></i>Project Dashboard</h1>
            <p class="page-subtitle">Monitor and manage all your projects in one place</p>
        </div>
        <div class="d-flex">
            <div class="dropdown me-2">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="timeRangeDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-calendar-alt me-2"></i>Last 30 Days
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">Last 7 Days</a></li>
                    <li><a class="dropdown-item" href="#">Last 30 Days</a></li>
                    <li><a class="dropdown-item" href="#">Last Quarter</a></li>
                    <li><a class="dropdown-item" href="#">Last Year</a></li>
                </ul>
            </div>
            <a href="{% url 'tracker_new_project' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Project
            </a>
        </div>
    </div>
</div>

<!-- Metrics Section -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-project-diagram"></i>
            </div>
            <div class="metric-value">{{ total_projects }}</div>
            <div class="metric-label">Total Projects</div>
            <div class="metric-trend text-success">
                <i class="fas fa-arrow-up me-1"></i> 12% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-spinner"></i>
            </div>
            <div class="metric-value">{{ active_projects }}</div>
            <div class="metric-label">Active Projects</div>
            <div class="metric-trend text-warning">
                <i class="fas fa-arrow-right me-1"></i> 3% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-value">{{ delayed_projects }}</div>
            <div class="metric-label">Delayed Projects</div>
            <div class="metric-trend text-danger">
                <i class="fas fa-arrow-up me-1"></i> 8% from last period
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-indian-rupee-sign"></i>
            </div>
            <div class="metric-value">₹{{ total_value|floatformat:0 }}</div>
            <div class="metric-label">Total Portfolio Value</div>
            <div class="metric-trend text-success">
                <i class="fas fa-arrow-up me-1"></i> 15% from last period
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar"></i>Project Completion Status
                <div class="chart-legend d-flex">
                    <span class="me-3"><span class="badge bg-primary me-1"></span> On Track</span>
                    <span class="me-3"><span class="badge bg-warning me-1"></span> At Risk</span>
                    <span><span class="badge bg-danger me-1"></span> Delayed</span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="progressChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie"></i>Project Status Distribution
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Projects -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list"></i>Recent Projects
                <a href="{% url 'tracker_index' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th>Project Code</th>
                                <th>Customer</th>
                                <th>Value</th>
                                <th>SO Punch Date</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in recent_projects %}
                            <tr>
                                <td><strong>{{ project.code }}</strong></td>
                                <td>{{ project.customer_name }}</td>
                                <td>₹{{ project.value|floatformat:2 }}</td>
                                <td>{{ project.so_punch_date|date:"M d, Y" }}</td>
                                <td>
                                    <span class="status-badge bg-{{ project.status|slugify }}">{{ project.status }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ project.get_completion_percentage }}%" 
                                                 aria-valuenow="{{ project.get_completion_percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <small>{{ project.get_completion_percentage }}%</small>
                                    </div>
                                </td>
                                <td>
                                    <a href="{% url 'tracker_project_detail' project.id %}" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'tracker_delete_project' project.id %}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Are you sure you want to delete this project?');">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    new Chart(progressCtx, {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: [
                {
                    label: 'On Track',
                    data: {{ on_track_data|safe }},
                    backgroundColor: 'rgba(67, 97, 238, 0.7)',
                    borderColor: 'rgba(67, 97, 238, 1)',
                    borderWidth: 1
                },
                {
                    label: 'At Risk',
                    data: {{ at_risk_data|safe }},
                    backgroundColor: 'rgba(255, 193, 7, 0.7)',
                    borderColor: 'rgba(255, 193, 7, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Delayed',
                    data: {{ delayed_data|safe }},
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    stacked: true,
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'Completion %' }
                },
                y: {
                    stacked: true
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}
