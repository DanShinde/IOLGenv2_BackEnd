{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}Project Reports | Project Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-chart-bar me-2"></i>Project Reports</h1>
    <p class="page-subtitle">Filter and analyze your project portfolio</p>
</div>

<div id="report-content">

    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-project-diagram"></i></div>
                <div class="metric-value">{{ total_projects_found }}</div>
                <div class="metric-label">Projects Found</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-indian-rupee-sign"></i></div>
                <div class="metric-value">₹{{ total_portfolio_value|intcomma }}</div>
                <div class="metric-label">Total Value of Found Projects</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-tasks"></i></div>
                <div class="metric-value">{{ average_completion|floatformat:1 }}%</div>
                <div class="metric-label">Average Completion</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon" style="color: #28a745; background: rgba(40, 167, 69, 0.1);"><i class="fas fa-check-double"></i></div>
                <div class="metric-value">{{ on_time_completion_rate|floatformat:1 }}%</div>
                <div class="metric-label">On-Time Completion</div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <a href="#filterCollapse" data-bs-toggle="collapse" class="card-header text-decoration-none d-flex justify-content-between align-items-center" role="button">
            <h5 class="card-header-title mb-0"><i class="fas fa-sliders-h me-2"></i>Filter Options</h5>
            <i class="fas fa-chevron-down"></i>
        </a>
        <div class="collapse" id="filterCollapse">
            <div class="card-body">
                <form method="get">
                    <fieldset class="mb-4">
                        <legend class="h6">General Filters</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Segments</label>
                                <select name="segments" class="form-select" multiple size="4">
                                    {% for segment in all_segments %}<option value="{{ segment.id }}" {% if segment.id in selected_segment_ids %}selected{% endif %}>{{ segment.name }}</option>{% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl or Cmd to select multiple.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SO Punch Date Range</label>
                                <div class="input-group">
                                    <span class="input-group-text">From</span>
                                    <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
                                    <span class="input-group-text">To</span>
                                    <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend class="h6">Stage Specific Filters</legend>
                        {% for stage_key, stage_display in stage_names %}{% with stage_values=stage_filters|get_item:stage_key %}<div class="row gx-2 gy-2 align-items-center mb-2">
                            <div class="col-md-2"><label class="form-label mb-0">{{ stage_display }}</label></div>
                            <div class="col-md-3"><select name="stage_{{ stage_key }}_status" class="form-select form-select-sm" aria-label="{{ stage_display }} Status"><option value="">-- Any Status --</option>{% for status_key, status_display in status_choices %}<option value="{{ status_key }}" {% if stage_values and stage_values.status == status_key %}selected{% endif %}>{{ status_display }}</option>{% endfor %}</select></div>
                            <div class="col-md-7"><div class="input-group input-group-sm"><span class="input-group-text">Actual Date</span><input type="date" name="stage_{{ stage_key }}_start" class="form-control" value="{{ stage_values.start|default:'' }}" aria-label="{{ stage_display }} Start Date"><span class="input-group-text">to</span><input type="date" name="stage_{{ stage_key }}_end" class="form-control" value="{{ stage_values.end|default:'' }}" aria-label="{{ stage_display }} End Date"></div></div>
                        </div>{% endwith %}{% endfor %}
                    </fieldset>
                    <hr class="my-4">
                    <div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i>Apply Filters</button>
                        <a href="{% url 'project_reports' %}" class="btn btn-outline-secondary">Reset Filters</a>
                        <a href="{% url 'export_report_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger ms-auto" target="_blank"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h5 class="card-header-title"><i class="fas fa-table me-2"></i>Filtered Results</h5></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-custom table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr><th>Code</th><th>Customer</th><th>Segment</th><th>Value</th><th>Completion</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}<tr>
                            <td><strong><a href="{% url 'tracker_project_detail' project.id %}">{{ project.code }}</a></strong></td>
                            <td>{{ project.customer_name }}</td><td>{{ project.segment_con.name|default:'N/A' }}</td>
                            <td>₹{{ project.value|floatformat:2|intcomma }}</td>
                            <td><div class="progress" style="height: 8px;"><div class="progress-bar" style="width: {{ project.get_completion_percentage }}%;"></div></div><small>{{ project.get_completion_percentage }}%</small></td>
                            <td><span class="status-badge bg-{{ project.get_overall_status|slugify }}">{{ project.get_overall_status }}</span></td>
                        </tr>{% empty %}<tr><td colspan="6" class="text-center py-5"><i class="fas fa-info-circle fa-2x text-muted mb-3"></i><p class="text-muted">No projects match your filter criteria.</p></td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-5"><div class="card h-100"><div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-pie"></i>Status Distribution</h5></div><div class="card-body d-flex justify-content-center align-items-center"><canvas id="statusPieChart"></canvas></div></div></div>
        <div class="col-md-7"><div class="card h-100"><div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-bar"></i>Projects by Segment</h5></div><div class="card-body"><canvas id="segmentBarChart"></canvas></div></div></div>
    </div>
    
    <div class="row mt-4">
        <div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header"><h5 class="card-header-title"><i class="fas fa-piggy-bank me-2"></i>Portfolio Value by Status</h5></div><div class="card-body"><canvas id="valueByStatusChart"></canvas></div></div></div>
        <div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header"><h5 class="card-header-title"><i class="fas fa-hourglass-half me-2"></i>Average Stage Duration (in Days)</h5></div><div class="card-body"><canvas id="stageDurationChart"></canvas></div></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status Pie Chart
    const statusCtx = document.getElementById('statusPieChart');
    if (statusCtx && {{ status_data|safe }}.length > 0) {
        new Chart(statusCtx, { type: 'pie', data: { labels: {{ status_labels|safe }}, datasets: [{ data: {{ status_data|safe }}, backgroundColor: ['#28a745','#ffc107','#dc3545','#6c757d'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
    }
    // Segment Bar Chart
    const segmentCtx = document.getElementById('segmentBarChart');
    if (segmentCtx && {{ segment_data|safe }}.length > 0) {
        new Chart(segmentCtx, { type: 'bar', data: { labels: {{ segment_labels|safe }}, datasets: [{ label: '# of Projects', data: {{ segment_data|safe }}, backgroundColor: 'rgba(67, 97, 238, 0.7)' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
    }
    // Value by Status Chart
    const valueByStatusCtx = document.getElementById('valueByStatusChart');
    if (valueByStatusCtx && {{ value_by_status_data|safe }}.length > 0) {
        new Chart(valueByStatusCtx, { type: 'bar', data: { labels: {{ value_by_status_labels|safe }}, datasets: [{ label: 'Total Value', data: {{ value_by_status_data|safe }}, backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d'] }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '₹' + new Intl.NumberFormat('en-IN', { notation: 'compact', maximumFractionDigits: 1 }).format(value); } } } } } });
    }
    // Stage Duration Chart
    const stageDurationCtx = document.getElementById('stageDurationChart');
    if (stageDurationCtx && {{ stage_duration_data|safe }}.length > 0) {
        new Chart(stageDurationCtx, { type: 'bar', data: { labels: {{ stage_duration_labels|safe }}, datasets: [{ label: 'Average Duration (Days)', data: {{ stage_duration_data|safe }}, backgroundColor: 'rgba(255, 159, 64, 0.7)' }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: 'Days' } } } } });
    }
});
</script>
{% endblock %}