{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}Project Reports | Project Tracker{% endblock %}

{% block extra_css %}
<style>
    .details-row td {
        background-color: #f8fafd;
        border-top: none !important;
        padding: 0 !important;
    }
    .details-content {
        padding: 1rem 1.5rem;
    }
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .detail-item h6 {
        color: var(--gray);
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
    }
    .detail-item p {
        font-weight: 500;
        margin-bottom: 0;
    }
</style>
{% endblock %}


{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-chart-bar me-2"></i>Project Reports</h1>
    <p class="page-subtitle">Filter and analyze your project portfolio</p>
</div>

<div id="report-content">

    <form method="get">
        {% if hide_completed_active %}
        <input type="hidden" name="hide_completed" value="1">
        {% endif %}
        <input type="hidden" name="chart_view" id="input_chart_view" value="monthly">
        <input type="hidden" name="chart_stage" id="input_chart_stage" value="">
        <input type="hidden" name="chart_year" id="input_chart_year" value="">
        <div class="card mb-4">
            <a href="#filterCollapse" data-bs-toggle="collapse" class="card-header text-decoration-none d-flex justify-content-between align-items-center" role="button">
                <h5 class="card-header-title mb-0"><i class="fas fa-sliders-h me-2"></i>Filter Options</h5>
                <i class="fas fa-chevron-down"></i>
            </a>
            <div class="collapse" id="filterCollapse">
                <div class="card-body">
                    <fieldset class="mb-4">
                        <legend class="h6">General Filters</legend>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Segments</label>
                                <select name="segments" class="form-select" multiple size="4">
                                    {% for segment in all_segments %}<option value="{{ segment.id }}" {% if segment.id in selected_segment_ids %}selected{% endif %}>{{ segment.name }}</option>{% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl or Cmd to select multiple.</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Team Leads (PACe)</label>
                                <select name="team_leads" class="form-select" multiple size="4">
                                    {% for employee in all_team_leads %}<option value="{{ employee.id }}" {% if employee.id in selected_team_lead_ids %}selected{% endif %}>{{ employee.name }}</option>{% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl or Cmd to select multiple.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SO Punch Date Range</label>
                                <div class="input-group">
                                    <span class="input-group-text">From</span>
                                    <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
                                    <span class="input-group-text">To</span>
                                    <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Value Range (in Cr.)</label>
                                <div class="input-group">
                                    <span class="input-group-text">Min</span>
                                    <input type="number" name="min_value" class="form-control" value="{{ min_value|default:'' }}" placeholder="e.g., 10" step="any">
                                    <span class="input-group-text">Max</span>
                                    <input type="number" name="max_value" class="form-control" value="{{ max_value|default:'' }}" placeholder="e.g., 50" step="any">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <a href="#advancedFilterCollapse" data-bs-toggle="collapse" role="button" class="btn btn-outline-secondary btn-sm mb-3 text-decoration-none">
                        <i class="fas fa-cogs me-2"></i>Advanced Stage Filters
                    </a>

                    <div class="collapse" id="advancedFilterCollapse">
                        <div class="card card-body bg-light border-0 p-3">
                            <ul class="nav nav-tabs mb-3" id="stageFilterTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-filters" type="button" role="tab"><i class="fas fa-robot me-2"></i>Automation Stages</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="emu-tab" data-bs-toggle="tab" data-bs-target="#emu-filters" type="button" role="tab"><i class="fas fa-laptop-code me-2"></i>Emulation Stages</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="stageFilterContent">
                                <!-- Automation Tab -->
                                <div class="tab-pane fade show active" id="auto-filters" role="tabpanel">
                                    {% for stage_key, stage_display in automation_stage_names %}
                                        {% include "tracker/partials/stage_filter_row.html" with stage_key=stage_key stage_display=stage_display stage_values=stage_filters|get_item:stage_key %}
                                    {% endfor %}
                                </div>
                                
                                <!-- Emulation Tab -->
                                <div class="tab-pane fade" id="emu-filters" role="tabpanel">
                                    {% for stage_key, stage_display in emulation_stage_names %}
                                        {% include "tracker/partials/stage_filter_row.html" with stage_key=stage_key stage_display=stage_display stage_values=stage_filters|get_item:stage_key %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex flex-wrap align-items-center justify-content-between gap-2">
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i>Apply Filters</button>
                <a href="{% url 'project_reports' %}?reset=true" class="btn btn-outline-secondary">Reset Filters</a>
                
                {% if hide_completed_active %}
                    <a href="?{{ request.GET.urlencode|cut:'&hide_completed=1'|cut:'hide_completed=1' }}" class="btn btn-info">
                        <i class="fas fa-eye me-2"></i>Show Completed
                    </a>
                {% else %}
                    <a href="?{{ request.GET.urlencode }}&hide_completed=1" class="btn btn-outline-info">
                        <i class="fas fa-eye-slash me-2"></i>Hide Completed
                    </a>
                {% endif %}
                
                <a href="{% url 'export_report_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger" target="_blank"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a>
            </div>
        </div>
    </form>

    <div class="card">
        <a href="#resultsCollapse" data-bs-toggle="collapse" class="card-header text-decoration-none d-flex justify-content-between align-items-center" role="button" aria-expanded="false" aria-controls="resultsCollapse">
            <div class="d-flex align-items-center">
                <h5 class="card-header-title mb-0"><i class="fas fa-table me-2"></i>Filtered Results</h5>
                <span class="badge bg-secondary ms-2" id="project-count-badge">{{ projects_with_details|length }} Found</span>
            </div>
            <i class="fas fa-chevron-down"></i>
        </a>
        <div class="collapse" id="resultsCollapse">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Customer</th>
                            <th>Segment</th>
                            <th>Team Lead</th>
                            <th>Value in Cr.</th>
                            <th>Completion</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        {# NEW: Row for filter inputs #}
                        <tr class="table-filter-row">
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Code..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Customer..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Segment..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Team Lead..." onkeyup="filterTable()"></th>
                            <th></th> {# No filter for Value #}
                            <th></th> {# No filter for Completion #}
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Status..." onkeyup="filterTable()"></th>
                            <th></th> {# No filter for Actions #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in projects_with_details %}
                        {% with project=item.project %}
                        <tr>
                            <td>
                                <strong><a href="{% url 'tracker_project_detail' project.id %}">{{ project.code }}</a></strong>
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.customer_name }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.segment_con.name|default:'N/A' }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.team_lead.name|default:'N/A' }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                ₹{{ project.value|floatformat:2|intcomma }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                <div class="progress" style="height: 8px;"><div class="progress-bar" style="width: {{ project.get_completion_percentage }}%;"></div></div><small>{{ project.get_completion_percentage }}%</small>
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                <span class="status-badge bg-{{ project.get_overall_status|slugify }}">{{ project.get_overall_status }}</span>
                            </td>
                            <td class="text-center">
                                <a href="{% url 'tracker_project_detail' project.id %}" class="btn btn-sm btn-outline-primary" title="View Project Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        <tr class="details-row">
                            <td colspan="8">
                                <div class="collapse" id="details-{{ project.id }}">
                                    <div class="details-content">
                                        <div class="details-grid">
                                            <div class="detail-item">
                                                <h6>SO Punch Date</h6>
                                                <p>{{ project.so_punch_date|date:"M d, Y" }}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Project OTIF</h6>
                                                <p>{{ item.otif|floatformat:1|default:"N/A" }}{% if item.otif %} %{% endif %}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Automation Schedule</h6>
                                                <p>
                                                    {% if item.auto_schedule is not None %}
                                                        {% if item.auto_schedule > 0 %}<span class="badge bg-danger">Delayed by {{ item.auto_schedule }} day{{ item.auto_schedule|pluralize }}</span>
                                                        {% elif item.auto_schedule < 0 %}<span class="badge bg-success">Ahead by {{ item.auto_schedule|abs }} day{{ item.auto_schedule|abs|pluralize }}</span>
                                                        {% else %}<span class="badge bg-primary">On Time</span>{% endif %}
                                                    {% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                                                </p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Emulation Schedule</h6>
                                                 <p>
                                                    {% if item.emu_schedule is not None %}
                                                        {% if item.emu_schedule > 0 %}<span class="badge bg-danger">Delayed by {{ item.emu_schedule }} day{{ item.emu_schedule|pluralize }}</span>
                                                        {% elif item.emu_schedule < 0 %}<span class="badge bg-success">Ahead by {{ item.emu_schedule|abs }} day{{ item.emu_schedule|abs|pluralize }}</span>
                                                        {% else %}<span class="badge bg-primary">On Time</span>{% endif %}
                                                    {% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                                                </p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Next Automation Milestone</h6>
                                                <p>{{ item.next_auto_milestone.name|default:"All stages complete." }}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Next Emulation Milestone</h6>
                                                <p>{{ item.next_emu_milestone.name|default:"All stages complete." }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% empty %}
                        <tr><td colspan="8" class="text-center py-5"><i class="fas fa-info-circle fa-2x text-muted mb-3"></i><p class="text-muted">No projects match your filter criteria.</p></td></tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-pie"></i>Status Distribution</h5></div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="statusPieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-bar"></i>Projects by Segment</h5></div>
                <div class="card-body">
                    <canvas id="segmentBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-users me-2"></i>Projects by Team Lead</h5></div>
                <div class="card-body">
                    <canvas id="teamLeadChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-exclamation-triangle me-2"></i>Top Process Bottlenecks (Delayed Stages)</h5></div>
                <div class="card-body">
                    <canvas id="stageDelayChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Common Chart Controls -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-body d-flex align-items-center gap-3 py-2">
                    <h6 class="mb-0 text-muted"><i class="fas fa-filter me-2"></i>Chart Controls:</h6>
                    
                    <div class="d-flex align-items-center gap-2">
                        <label class="small fw-bold">Stage:</label>
                        <select id="commonStageSelector" class="form-select form-select-sm w-auto" onchange="handleCommonFilterChange()">
                            <optgroup label="Automation">
                                {% for stage_key, stage_display in automation_stage_names %}<option value="{{ stage_key }}">{{ stage_display }}</option>{% endfor %}
                            </optgroup>
                            <optgroup label="Emulation">
                                {% for stage_key, stage_display in emulation_stage_names %}<option value="{{ stage_key }}">{{ stage_display }}</option>{% endfor %}
                            </optgroup>
                        </select>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <label class="small fw-bold">View:</label>
                        <select id="commonViewSelector" class="form-select form-select-sm w-auto" onchange="handleCommonFilterChange()">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                        </select>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <label class="small fw-bold">Year:</label>
                        <select id="commonYearSelector" class="form-select form-select-sm w-auto" style="display: none;" onchange="handleCommonFilterChange()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-header-title mb-0"><i class="fas fa-chart-line me-2"></i>Stage Performance Trends (Planned vs Actual)</h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="stageTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-header-title mb-0"><i class="fas fa-percentage me-2"></i>Stage OTIF Trends (On Time In Full)</h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="stageOtifChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-header-title mb-0"><i class="fas fa-stopwatch me-2"></i>Emulation Timing Analysis</h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="emuTimingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}

{{ block.super }}
<script>
// ✅ NEW: Function to make cards in a row the same height
function equalizeChartCardHeights() {
    const chartRows = document.querySelectorAll('.row.mt-4');
    
    chartRows.forEach(row => {
        const cards = row.querySelectorAll('.card');
        if (cards.length < 2) return;

        // Use a small timeout to ensure charts have rendered before we measure them
        setTimeout(() => {
            let maxHeight = 0;
            // First, reset any previously set heights to get the natural height
            cards.forEach(card => {
                card.style.height = 'auto';
            });

            // Find the height of the tallest card
            cards.forEach(card => {
                if (card.offsetHeight > maxHeight) {
                    maxHeight = card.offsetHeight;
                }
            });

            // Set all cards to the height of the tallest one
            cards.forEach(card => {
                card.style.height = `${maxHeight}px`;
            });
        }, 200); // 200ms delay
    });
}


document.addEventListener('DOMContentLoaded', function() {
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    // --- Chart Initialization Code ---

    // Status Pie Chart
    const statusCtx = document.getElementById('statusPieChart');
    if (statusCtx && {{ status_data|safe }}.length > 0) {
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: {{ status_labels|safe }},
                datasets: [{
                    data: {{ status_data|safe }},
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    datalabels: {
                        color: '#fff', font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                            return `${value} (${percentage})`;
                        }
                    }
                }
            }
        });
    }

    // Segment Bar Chart
    const segmentCtx = document.getElementById('segmentBarChart');
    const segmentData = {{ segment_data|safe }};
    if (segmentCtx && segmentData.length > 0) {
        const maxSegmentValue = Math.max(...segmentData);
        new Chart(segmentCtx, {
            type: 'bar',
            data: {
                labels: {{ segment_labels|safe }},
                datasets: [{
                    label: '# of Projects',
                    data: segmentData,
                    backgroundColor: 'rgba(67, 97, 238, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'end', color: '#444', font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true, ticks: { stepSize: 1 }, max: maxSegmentValue + 2
                    }
                }
            }
        });
    }

    // Team Lead Bar Chart
    const teamLeadCtx = document.getElementById('teamLeadChart');
    const teamLeadData = {{ team_lead_data|safe }};
    if (teamLeadCtx && teamLeadData.length > 0) {
        new Chart(teamLeadCtx, {
            type: 'bar',
            data: {
                labels: {{ team_lead_labels|safe }},
                datasets: [{
                    label: 'Active Projects',
                    data: teamLeadData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    // Stage Delay Bar Chart
    const stageDelayCtx = document.getElementById('stageDelayChart');
    const stageDelayData = {{ stage_delay_data|safe }};
    if (stageDelayCtx && stageDelayData.length > 0) {
        new Chart(stageDelayCtx, {
            type: 'bar',
            data: {
                labels: {{ stage_delay_labels|safe }},
                datasets: [{
                    label: 'Delayed Projects',
                    data: stageDelayData,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }
    
    // ✅ NEW: Call the function to make the cards the same height
    equalizeChartCardHeights();
    // Optional: Re-run when the window is resized
    window.addEventListener('resize', equalizeChartCardHeights);

    // --- Chart Initialization with Persistence ---
    
    const urlParams = new URLSearchParams(window.location.search);
    const filterStage = urlParams.get('chart_filter_stage');
    const filterMonth = urlParams.get('chart_filter_month');
    const filterType = urlParams.get('chart_filter_type');
    const chartViewParam = urlParams.get('chart_view');
    const chartStageParam = urlParams.get('chart_stage');
    const chartYearParam = urlParams.get('chart_year');

    function getFYFromDateStr(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return null;
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        let fyStart = (month >= 4) ? year : year - 1;
        let fyEnd = fyStart + 1;
        return `FY ${String(fyStart).slice(-2)}-${String(fyEnd).slice(-2)}`;
    }

    // Initialize Common Controls and Charts
    if (document.getElementById('commonStageSelector')) {
        const stageSelector = document.getElementById('commonStageSelector');
        const viewSelector = document.getElementById('commonViewSelector');
        const yearSelector = document.getElementById('commonYearSelector');
        
        // 1. Set Stage
        // Priority: Explicit chart_stage > Click filter stage
        let targetStage = chartStageParam || (filterStage ? filterStage : null);
        if (targetStage && [...stageSelector.options].some(o => o.value === targetStage)) {
            stageSelector.value = targetStage;
        }

        // 2. Set View
        if (chartViewParam) {
            viewSelector.value = chartViewParam;
        }

        // 3. Populate Years based on Stage
        populateCommonYearSelector();

        // 4. Set Year
        // Priority: Explicit chart_year > Derived from click filter month
        let targetYear = chartYearParam;
        if (!targetYear && filterMonth) {
            targetYear = getFYFromDateStr(filterMonth);
        }
        if (targetYear && [...yearSelector.options].some(o => o.value === targetYear)) {
            yearSelector.value = targetYear;
        }

        // 5. Update Charts
        updateTrendChart();
        updateOtifChart();
        updateEmuChart();
    }
});

// Stage Trend Chart Logic
const trendCtx = document.getElementById('stageTrendChart');
const allTrendData = JSON.parse('{{ stage_trend_data|escapejs }}');
let trendChart = null;

function handleCommonFilterChange() {
    populateCommonYearSelector();
    updateTrendChart();
    updateOtifChart();
    updateEmuChart();
}

function populateCommonYearSelector() {
    const stageSelector = document.getElementById('commonStageSelector');
    const yearSelector = document.getElementById('commonYearSelector');
    
    // Store current selection before clearing
    const currentSelection = yearSelector.value;

    const selectedStage = stageSelector.value;
    const trendData = allTrendData[selectedStage];
    const otifData = allOtifData[selectedStage];
    const emuData = emuTimingData; // Global variable from below

    yearSelector.innerHTML = '';
    
    // Combine years from both datasets to ensure coverage
    let years = [];
    if (trendData && trendData.financial_years) years = [...years, ...trendData.financial_years];
    if (otifData && otifData.financial_years) years = [...years, ...otifData.financial_years];
    if (emuData && emuData.financial_years) years = [...years, ...emuData.financial_years];

    if (years.length === 0) {
        yearSelector.style.display = 'none';
        return;
    }

    // Extract unique FYs and sort descending
    const uniqueFYs = [...new Set(years)].sort().reverse();
    
    // Only show selector if we have data
    if (uniqueFYs.length > 0) {
        yearSelector.style.display = 'block';
        uniqueFYs.forEach(fy => {
            const option = document.createElement('option');
            option.value = fy;
            option.text = fy;
            yearSelector.appendChild(option);
        });
        
        // Try to retain selection, otherwise default to latest
        if (currentSelection && uniqueFYs.includes(currentSelection)) {
            yearSelector.value = currentSelection;
        } else {
            yearSelector.value = uniqueFYs[0];
        }
    } else {
        yearSelector.style.display = 'none';
    }
}

function updateTrendChart() {
    if (!trendCtx) return;
    
    const stageSelector = document.getElementById('commonStageSelector');
    const viewSelector = document.getElementById('commonViewSelector');
    const yearSelector = document.getElementById('commonYearSelector');
    const selectedStage = stageSelector.value;
    const viewType = viewSelector ? viewSelector.value : 'monthly';
    const selectedFY = yearSelector.value;

    // Update hidden input and URL state for persistence
    if (document.getElementById('input_chart_view')) document.getElementById('input_chart_view').value = viewType;
    if (document.getElementById('input_chart_stage')) document.getElementById('input_chart_stage').value = selectedStage;
    if (document.getElementById('input_chart_year')) document.getElementById('input_chart_year').value = selectedFY;

    const url = new URL(window.location.href);
    url.searchParams.set('chart_view', viewType);
    url.searchParams.set('chart_stage', selectedStage);
    url.searchParams.set('chart_year', selectedFY);
    window.history.replaceState({}, '', url);
    
    const rawData = allTrendData[selectedStage] || { labels: [], years: [], financial_years: [], months: [], planned: [], actual: [] };
    
    // Filter data based on selected year
    let filteredLabels = [];
    let filteredPlanned = [];
    let filteredActual = [];
    let filteredYears = [];
    let filteredMonths = [];

    if (viewType === 'monthly') {
        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    filteredLabels.push(rawData.labels[i]);
                    filteredPlanned.push(rawData.planned[i]);
                    filteredActual.push(rawData.actual[i]);
                    filteredYears.push(rawData.years[i]);
                    filteredMonths.push(rawData.months[i]);
                }
            }
        }
    } else {
        // Quarterly Aggregation
        filteredLabels = ['Q1 (Apr-Jun)', 'Q2 (Jul-Sep)', 'Q3 (Oct-Dec)', 'Q4 (Jan-Mar)'];
        filteredPlanned = [0, 0, 0, 0];
        filteredActual = [0, 0, 0, 0];
        
        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    const month = rawData.months[i]; // 1-12
                    
                    // Indian Financial Year Logic: Q1=Apr-Jun
                    let quarterIndex;
                    if (month >= 4) {
                        quarterIndex = Math.floor((month - 4) / 3); // 4-6->0, 7-9->1, 10-12->2
                    } else {
                        quarterIndex = 3; // 1-3 -> 3 (Q4)
                    }
                    
                    filteredPlanned[quarterIndex] += rawData.planned[i];
                    filteredActual[quarterIndex] += rawData.actual[i];
                }
            }
        }
    }

    if (trendChart) {
        trendChart.destroy();
    }

    trendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: filteredLabels,
            datasets: [
                {
                    label: 'Planned Completion',
                    data: filteredPlanned,
                    borderColor: '#0d6efd', // Bootstrap Primary
                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                },
                {
                    label: 'Actual Completion',
                    data: filteredActual,
                    borderColor: '#198754', // Bootstrap Success
                    backgroundColor: 'rgba(25, 135, 84, 0.7)',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            onClick: (e, activeElements) => {
                if (activeElements.length === 0 || viewType !== 'monthly') return;
                
                const index = activeElements[0].index;
                const datasetIndex = activeElements[0].datasetIndex;
                
                const year = filteredYears[index];
                const month = filteredMonths[index];
                const stage = selectedStage;
                const type = datasetIndex === 0 ? 'planned' : 'actual';
                
                const dateStr = `${year}-${String(month).padStart(2, '0')}-01`;
                
                const url = new URL(window.location.href);
                url.searchParams.set('chart_filter_stage', stage);
                url.searchParams.set('chart_filter_month', dateStr);
                url.searchParams.set('chart_filter_type', type);
                url.hash = 'resultsCollapse';
                
                window.location.href = url.toString();
            },
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#444',
                    font: { weight: 'bold' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    title: { display: true, text: 'Number of Projects' }
                }
            }
        }
    });
}

// --- Stage OTIF Chart Logic ---
const otifCtx = document.getElementById('stageOtifChart');
const allOtifData = JSON.parse('{{ stage_otif_data|escapejs }}');
let otifChart = null;

function updateOtifChart() {
    if (!otifCtx) return;
    
    const stageSelector = document.getElementById('commonStageSelector');
    const viewSelector = document.getElementById('commonViewSelector');
    const yearSelector = document.getElementById('commonYearSelector');
    const selectedStage = stageSelector.value;
    const viewType = viewSelector ? viewSelector.value : 'monthly';
    const selectedFY = yearSelector.value;

    // Hidden inputs and URL state are already updated by updateTrendChart, 
    // but we can leave them here or remove them. 
    // It's safer to keep them in case this function is called independently in future.
    
    const rawData = allOtifData[selectedStage] || { labels: [], financial_years: [], months: [], total: [], on_time: [] };
    
    let filteredLabels = [];
    let filteredData = [];
    let filteredTotal = [];
    let filteredOnTime = [];
    let filteredYears = [];
    let filteredMonths = [];

    if (viewType === 'monthly') {
        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    filteredLabels.push(rawData.labels[i]);
                    const total = rawData.total[i];
                    const onTime = rawData.on_time[i];
                    const percentage = total > 0 ? (onTime / total) * 100 : 0;
                    filteredData.push(percentage);
                    filteredTotal.push(total);
                    filteredOnTime.push(onTime);
                    filteredYears.push(rawData.years[i]);
                    filteredMonths.push(rawData.months[i]);
                }
            }
        }
    } else {
        // Quarterly Aggregation (IFY)
        filteredLabels = ['Q1 (Apr-Jun)', 'Q2 (Jul-Sep)', 'Q3 (Oct-Dec)', 'Q4 (Jan-Mar)'];
        let qTotal = [0, 0, 0, 0];
        let qOnTime = [0, 0, 0, 0];
        
        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    const month = rawData.months[i];
                    let quarterIndex;
                    if (month >= 4) {
                        quarterIndex = Math.floor((month - 4) / 3);
                    } else {
                        quarterIndex = 3;
                    }
                    qTotal[quarterIndex] += rawData.total[i];
                    qOnTime[quarterIndex] += rawData.on_time[i];
                }
            }
        }
        
        // Calculate percentages for quarters
        filteredData = qTotal.map((total, index) => total > 0 ? (qOnTime[index] / total) * 100 : 0);
        filteredTotal = qTotal;
        filteredOnTime = qOnTime;
    }

    if (otifChart) {
        otifChart.destroy();
    }

    // Create target line data (80%)
    const targetData = new Array(filteredLabels.length).fill(80);

    otifChart = new Chart(otifCtx, {
        type: 'line',
        data: {
            labels: filteredLabels,
            datasets: [{
                label: 'OTIF %',
                data: filteredData,
                totalData: filteredTotal,
                onTimeData: filteredOnTime,
                backgroundColor: 'rgba(111, 66, 193, 0.2)', // Purple with transparency
                borderColor: '#6c757d',
                segment: {
                    borderColor: ctx => ctx.p1.parsed.y >= 80 ? '#198754' : '#dc3545'
                },
                pointBackgroundColor: ctx => ctx.parsed.y >= 80 ? '#198754' : '#dc3545',
                pointBorderColor: ctx => ctx.parsed.y >= 80 ? '#198754' : '#dc3545',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            },
            {
                label: 'Target (80%)',
                data: targetData,
                borderColor: '#dc3545', // Bootstrap Danger (Red)
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                datalabels: { display: false }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, activeElements) => {
                if (activeElements.length === 0 || viewType !== 'monthly') return;
                
                const index = activeElements[0].index;
                // Dataset 0 is the OTIF line, Dataset 1 is the Target line
                if (activeElements[0].datasetIndex !== 0) return;

                const year = filteredYears[index];
                const month = filteredMonths[index];
                const stage = selectedStage;
                
                const dateStr = `${year}-${String(month).padStart(2, '0')}-01`;
                
                const url = new URL(window.location.href);
                url.searchParams.set('chart_filter_stage', stage);
                url.searchParams.set('chart_filter_month', dateStr);
                url.searchParams.set('chart_filter_type', 'otif_total');
                url.hash = 'resultsCollapse';
                
                window.location.href = url.toString();
            },
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const percentage = context.parsed.y.toFixed(2) + '%';
                            const index = context.dataIndex;
                            const dataset = context.dataset;
                            const onTime = dataset.onTimeData[index];
                            const total = dataset.totalData[index];
                            return `OTIF: ${percentage} (${onTime}/${total})`;
                        }
                    }
                },
                datalabels: {
                    align: 'top',
                    anchor: 'center',
                    color: '#333',
                    font: { weight: 'bold', size: 11 },
                    formatter: function(value) {
                        return value.toFixed(2) + '%';
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: 'Percentage (%)' }
                }
            }
        }
    });
}

// --- Emulation Timing Chart Logic ---
const emuTimingCtx = document.getElementById('emuTimingChart');
const emuTimingData = JSON.parse('{{ emu_timing_data|escapejs }}');
let emuChart = null;

function updateEmuChart() {
    if (!emuTimingCtx) return;

    const viewSelector = document.getElementById('commonViewSelector');
    const yearSelector = document.getElementById('commonYearSelector');
    const viewType = viewSelector ? viewSelector.value : 'monthly';
    const selectedFY = yearSelector.value;

    const rawData = emuTimingData || { labels: [], financial_years: [], months: [], cat1: [], cat2: [], cat3: [] };

    let filteredLabels = [];
    let filteredCat1 = [];
    let filteredCat2 = [];
    let filteredCat3 = [];

    if (viewType === 'monthly') {
        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    filteredLabels.push(rawData.labels[i]);
                    filteredCat1.push(rawData.cat1[i]);
                    filteredCat2.push(rawData.cat2[i]);
                    filteredCat3.push(rawData.cat3[i]);
                }
            }
        }
    } else {
        // Quarterly Aggregation
        filteredLabels = ['Q1 (Apr-Jun)', 'Q2 (Jul-Sep)', 'Q3 (Oct-Dec)', 'Q4 (Jan-Mar)'];
        filteredCat1 = [0, 0, 0, 0];
        filteredCat2 = [0, 0, 0, 0];
        filteredCat3 = [0, 0, 0, 0];

        if (rawData.financial_years) {
            for (let i = 0; i < rawData.financial_years.length; i++) {
                if (rawData.financial_years[i] === selectedFY) {
                    const month = rawData.months[i];
                    let quarterIndex;
                    if (month >= 4) {
                        quarterIndex = Math.floor((month - 4) / 3);
                    } else {
                        quarterIndex = 3;
                    }
                    filteredCat1[quarterIndex] += rawData.cat1[i];
                    filteredCat2[quarterIndex] += rawData.cat2[i];
                    filteredCat3[quarterIndex] += rawData.cat3[i];
                }
            }
        }
    }

    if (emuChart) {
        emuChart.destroy();
    }

    emuChart = new Chart(emuTimingCtx, {
        type: 'bar',
        data: {
            labels: filteredLabels,
            datasets: [
                {
                    label: 'Before Dispatch',
                    data: filteredCat1,
                    backgroundColor: 'rgba(25, 135, 84, 0.7)', // Success Green
                },
                {
                    label: 'After Dispatch / Before Go Live',
                    data: filteredCat2,
                    backgroundColor: 'rgba(255, 193, 7, 0.7)', // Warning Yellow
                },
                {
                    label: 'After Go Live',
                    data: filteredCat3,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)', // Danger Red
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true,
                    beginAtZero: true,
                    title: { display: true, text: 'Number of Projects' }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                },
                datalabels: {
                    anchor: 'center', align: 'center', color: '#fff', font: { weight: 'bold' },
                    formatter: (value) => value > 0 ? value : ''
                }
            }
        }
    });
}

// Function to clear inputs for a specific stage row
function clearStageRow(btn) {
    const row = btn.closest('.row');
    row.querySelectorAll('input, select').forEach(el => {
        if (el.tagName === 'SELECT' && el.multiple) {
             Array.from(el.options).forEach(opt => opt.selected = false);
        } else {
            el.value = '';
        }
    });
}
</script>

<script>
    // The filterTable function remains unchanged
    function filterTable() {
        const filterValues = {
            code: document.querySelector('.table-filter-row th:nth-child(1) input').value.toUpperCase(),

            customer: document.querySelector('.table-filter-row th:nth-child(2) input').value.toUpperCase(),
            segment: document.querySelector('.table-filter-row th:nth-child(3) input').value.toUpperCase(),
            teamLead: document.querySelector('.table-filter-row th:nth-child(4) input').value.toUpperCase(),
            status: document.querySelector('.table-filter-row th:nth-child(7) input').value.toUpperCase()

        };
        const tableBody = document.querySelector('.table-custom tbody');
        if (!tableBody) { return; }
        const allRows = tableBody.getElementsByTagName('tr');
        let visibleProjectCount = 0;
        let noResultsRow = null;
        for (let i = 0; i < allRows.length; i++) {
            const row = allRows[i];
            if (row.classList.contains('details-row')) { continue; }
            if (row.cells.length === 1 && row.cells[0].hasAttribute('colspan')) {
                noResultsRow = row;
                continue;
            }
            const detailsRow = allRows[i + 1];
            const rowData = {
                code: row.cells[0]?.textContent.toUpperCase() || '',
                customer: row.cells[1]?.textContent.toUpperCase() || '',
                segment: row.cells[2]?.textContent.toUpperCase() || '',

                teamLead: row.cells[3]?.textContent.toUpperCase() || '',
                status: row.cells[6]?.textContent.toUpperCase() || ''

            };
            const isMatch = rowData.code.includes(filterValues.code) &&
                            rowData.customer.includes(filterValues.customer) &&
                            rowData.segment.includes(filterValues.segment) &&
                            rowData.teamLead.includes(filterValues.teamLead) &&

                            rowData.status.includes(filterValues.status);
            if (isMatch) {
                row.style.display = 'table-row';
                if (detailsRow) detailsRow.style.display = 'table-row';
                visibleProjectCount++;
            } else {
                row.style.display = 'none';
                if (detailsRow) detailsRow.style.display = 'none';
            }
        }
        if (noResultsRow) {
            noResultsRow.style.display = (visibleProjectCount === 0) ? 'table-row' : 'none';
        }

        const countBadge = document.getElementById('project-count-badge');
        if (countBadge) {
            countBadge.textContent = visibleProjectCount + ' Found';
        }
    }
</script>
{% endblock %}