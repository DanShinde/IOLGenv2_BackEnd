{% extends 'tracker/base.html' %}
{% load custom_tags %}
{% load humanize %}

{% block title %}Project Reports | Project Tracker{% endblock %}

{% block extra_css %}
<style>
    .details-row td {
        background-color: #f8fafd;
        border-top: none !important;
        padding: 0 !important;
    }
    .details-content {
        padding: 1rem 1.5rem;
    }
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .detail-item h6 {
        color: var(--gray);
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
    }
    .detail-item p {
        font-weight: 500;
        margin-bottom: 0;
    }
</style>
{% endblock %}


{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-chart-bar me-2"></i>Project Reports</h1>
    <p class="page-subtitle">Filter and analyze your project portfolio</p>
</div>

<div id="report-content">

    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-project-diagram"></i></div>
                <div class="metric-value">{{ total_projects_found }}</div>
                <div class="metric-label">Projects Found</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-indian-rupee-sign"></i></div>
                <div class="metric-value">₹{{ total_portfolio_value|intcomma }}</div>
                <div class="metric-label">Total Value of Found Projects in Cr.</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon"><i class="fas fa-tasks"></i></div>
                <div class="metric-value">{{ average_completion|floatformat:1 }}%</div>
                <div class="metric-label">Average Completion</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3 d-flex">
            <div class="metric-card h-100 w-100">
                <div class="metric-icon" style="color: #28a745; background: rgba(40, 167, 69, 0.1);"><i class="fas fa-check-double"></i></div>
                <div class="metric-value">{{ on_time_completion_rate|floatformat:1 }}%</div>
                <div class="metric-label">On-Time Completion</div>
            </div>
        </div>
    </div>

    <form method="get">
        {% if hide_completed_active %}
        <input type="hidden" name="hide_completed" value="1">
        {% endif %}
        <div class="card mb-4">
            <a href="#filterCollapse" data-bs-toggle="collapse" class="card-header text-decoration-none d-flex justify-content-between align-items-center" role="button">
                <h5 class="card-header-title mb-0"><i class="fas fa-sliders-h me-2"></i>Filter Options</h5>
                <i class="fas fa-chevron-down"></i>
            </a>
            <div class="collapse" id="filterCollapse">
                <div class="card-body">
                    <fieldset class="mb-4">
                        <legend class="h6">General Filters</legend>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Segments</label>
                                <select name="segments" class="form-select" multiple size="4">
                                    {% for segment in all_segments %}<option value="{{ segment.id }}" {% if segment.id in selected_segment_ids %}selected{% endif %}>{{ segment.name }}</option>{% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl or Cmd to select multiple.</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Team Leads (PACe)</label>
                                <select name="team_leads" class="form-select" multiple size="4">
                                    {% for employee in all_team_leads %}<option value="{{ employee.id }}" {% if employee.id in selected_team_lead_ids %}selected{% endif %}>{{ employee.name }}</option>{% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl or Cmd to select multiple.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SO Punch Date Range</label>
                                <div class="input-group">
                                    <span class="input-group-text">From</span>
                                    <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
                                    <span class="input-group-text">To</span>
                                    <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Value Range (in Cr.)</label>
                                <div class="input-group">
                                    <span class="input-group-text">Min</span>
                                    <input type="number" name="min_value" class="form-control" value="{{ min_value|default:'' }}" placeholder="e.g., 10" step="any">
                                    <span class="input-group-text">Max</span>
                                    <input type="number" name="max_value" class="form-control" value="{{ max_value|default:'' }}" placeholder="e.g., 50" step="any">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <a href="#advancedFilterCollapse" data-bs-toggle="collapse" role="button" class="btn btn-outline-secondary btn-sm mb-3 text-decoration-none">
                        <i class="fas fa-cogs me-2"></i>Advanced Stage Filters
                    </a>

                    <div class="collapse" id="advancedFilterCollapse">
                        <div class="card card-body bg-light border-0 p-3">
                            <ul class="nav nav-tabs mb-3" id="stageFilterTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-filters" type="button" role="tab"><i class="fas fa-robot me-2"></i>Automation Stages</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="emu-tab" data-bs-toggle="tab" data-bs-target="#emu-filters" type="button" role="tab"><i class="fas fa-laptop-code me-2"></i>Emulation Stages</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="stageFilterContent">
                                <!-- Automation Tab -->
                                <div class="tab-pane fade show active" id="auto-filters" role="tabpanel">
                                    {% for stage_key, stage_display in automation_stage_names %}
                                        {% include "tracker/partials/stage_filter_row.html" with stage_key=stage_key stage_display=stage_display stage_values=stage_filters|get_item:stage_key %}
                                    {% endfor %}
                                </div>
                                
                                <!-- Emulation Tab -->
                                <div class="tab-pane fade" id="emu-filters" role="tabpanel">
                                    {% for stage_key, stage_display in emulation_stage_names %}
                                        {% include "tracker/partials/stage_filter_row.html" with stage_key=stage_key stage_display=stage_display stage_values=stage_filters|get_item:stage_key %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex flex-wrap align-items-center justify-content-between gap-2">
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i>Apply Filters</button>
                <a href="{% url 'project_reports' %}?reset=true" class="btn btn-outline-secondary">Reset Filters</a>
                
                {% if hide_completed_active %}
                    <a href="?{{ request.GET.urlencode|cut:'&hide_completed=1'|cut:'hide_completed=1' }}" class="btn btn-info">
                        <i class="fas fa-eye me-2"></i>Show Completed
                    </a>
                {% else %}
                    <a href="?{{ request.GET.urlencode }}&hide_completed=1" class="btn btn-outline-info">
                        <i class="fas fa-eye-slash me-2"></i>Hide Completed
                    </a>
                {% endif %}
                
                <a href="{% url 'export_report_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger" target="_blank"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a>
            </div>
        </div>
    </form>

    <div class="card">
        <div class="card-header"><h5 class="card-header-title"><i class="fas fa-table me-2"></i>Filtered Results</h5></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Customer</th>
                            <th>Segment</th>
                            <th>Team Lead</th>
                            <th>Value in Cr.</th>
                            <th>Completion</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        {# NEW: Row for filter inputs #}
                        <tr class="table-filter-row">
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Code..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Customer..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Segment..." onkeyup="filterTable()"></th>
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Team Lead..." onkeyup="filterTable()"></th>
                            <th></th> {# No filter for Value #}
                            <th></th> {# No filter for Completion #}
                            <th><input type="text" class="form-control form-control-sm" placeholder="Filter Status..." onkeyup="filterTable()"></th>
                            <th></th> {# No filter for Actions #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in projects_with_details %}
                        {% with project=item.project %}
                        <tr>
                            <td>
                                <strong><a href="{% url 'tracker_project_detail' project.id %}">{{ project.code }}</a></strong>
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.customer_name }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.segment_con.name|default:'N/A' }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                {{ project.team_lead.name|default:'N/A' }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                ₹{{ project.value|floatformat:2|intcomma }}
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                <div class="progress" style="height: 8px;"><div class="progress-bar" style="width: {{ project.get_completion_percentage }}%;"></div></div><small>{{ project.get_completion_percentage }}%</small>
                            </td>
                            <td data-bs-toggle="collapse" data-bs-target="#details-{{ project.id }}" style="cursor: pointer;">
                                <span class="status-badge bg-{{ project.get_overall_status|slugify }}">{{ project.get_overall_status }}</span>
                            </td>
                            <td class="text-center">
                                <a href="{% url 'tracker_project_detail' project.id %}" class="btn btn-sm btn-outline-primary" title="View Project Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        <tr class="details-row">
                            <td colspan="8">
                                <div class="collapse" id="details-{{ project.id }}">
                                    <div class="details-content">
                                        <div class="details-grid">
                                            <div class="detail-item">
                                                <h6>SO Punch Date</h6>
                                                <p>{{ project.so_punch_date|date:"M d, Y" }}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Project OTIF</h6>
                                                <p>{{ item.otif|floatformat:1|default:"N/A" }}{% if item.otif %} %{% endif %}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Automation Schedule</h6>
                                                <p>
                                                    {% if item.auto_schedule is not None %}
                                                        {% if item.auto_schedule > 0 %}<span class="badge bg-danger">Delayed by {{ item.auto_schedule }} day{{ item.auto_schedule|pluralize }}</span>
                                                        {% elif item.auto_schedule < 0 %}<span class="badge bg-success">Ahead by {{ item.auto_schedule|abs }} day{{ item.auto_schedule|abs|pluralize }}</span>
                                                        {% else %}<span class="badge bg-primary">On Time</span>{% endif %}
                                                    {% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                                                </p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Emulation Schedule</h6>
                                                 <p>
                                                    {% if item.emu_schedule is not None %}
                                                        {% if item.emu_schedule > 0 %}<span class="badge bg-danger">Delayed by {{ item.emu_schedule }} day{{ item.emu_schedule|pluralize }}</span>
                                                        {% elif item.emu_schedule < 0 %}<span class="badge bg-success">Ahead by {{ item.emu_schedule|abs }} day{{ item.emu_schedule|abs|pluralize }}</span>
                                                        {% else %}<span class="badge bg-primary">On Time</span>{% endif %}
                                                    {% else %}<span class="text-muted small">Not enough data</span>{% endif %}
                                                </p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Next Automation Milestone</h6>
                                                <p>{{ item.next_auto_milestone.name|default:"All stages complete." }}</p>
                                            </div>
                                            <div class="detail-item">
                                                <h6>Next Emulation Milestone</h6>
                                                <p>{{ item.next_emu_milestone.name|default:"All stages complete." }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% empty %}
                        <tr><td colspan="8" class="text-center py-5"><i class="fas fa-info-circle fa-2x text-muted mb-3"></i><p class="text-muted">No projects match your filter criteria.</p></td></tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-pie"></i>Status Distribution</h5></div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="statusPieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-chart-bar"></i>Projects by Segment</h5></div>
                <div class="card-body">
                    <canvas id="segmentBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-users me-2"></i>Projects by Team Lead</h5></div>
                <div class="card-body">
                    <canvas id="teamLeadChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5 class="card-header-title"><i class="fas fa-exclamation-triangle me-2"></i>Top Process Bottlenecks (Delayed Stages)</h5></div>
                <div class="card-body">
                    <canvas id="stageDelayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}

{{ block.super }}
<script>
// ✅ NEW: Function to make cards in a row the same height
function equalizeChartCardHeights() {
    const chartRow = document.querySelector('.row.mt-4');
    if (!chartRow) return;

    const cards = chartRow.querySelectorAll('.card');
    if (cards.length < 2) return;

    // Use a small timeout to ensure charts have rendered before we measure them
    setTimeout(() => {
        let maxHeight = 0;
        // First, reset any previously set heights to get the natural height
        cards.forEach(card => {
            card.style.height = 'auto';
        });

        // Find the height of the tallest card
        cards.forEach(card => {
            if (card.offsetHeight > maxHeight) {
                maxHeight = card.offsetHeight;
            }
        });

        // Set all cards to the height of the tallest one
        cards.forEach(card => {
            card.style.height = `${maxHeight}px`;
        });
    }, 200); // 200ms delay
}


document.addEventListener('DOMContentLoaded', function() {
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    // --- Chart Initialization Code ---

    // Status Pie Chart
    const statusCtx = document.getElementById('statusPieChart');
    if (statusCtx && {{ status_data|safe }}.length > 0) {
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: {{ status_labels|safe }},
                datasets: [{
                    data: {{ status_data|safe }},
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    datalabels: {
                        color: '#fff', font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                            return `${value} (${percentage})`;
                        }
                    }
                }
            }
        });
    }

    // Segment Bar Chart
    const segmentCtx = document.getElementById('segmentBarChart');
    const segmentData = {{ segment_data|safe }};
    if (segmentCtx && segmentData.length > 0) {
        const maxSegmentValue = Math.max(...segmentData);
        new Chart(segmentCtx, {
            type: 'bar',
            data: {
                labels: {{ segment_labels|safe }},
                datasets: [{
                    label: '# of Projects',
                    data: segmentData,
                    backgroundColor: 'rgba(67, 97, 238, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'end', color: '#444', font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true, ticks: { stepSize: 1 }, max: maxSegmentValue + 2
                    }
                }
            }
        });
    }

    // Team Lead Bar Chart
    const teamLeadCtx = document.getElementById('teamLeadChart');
    const teamLeadData = {{ team_lead_data|safe }};
    if (teamLeadCtx && teamLeadData.length > 0) {
        new Chart(teamLeadCtx, {
            type: 'bar',
            data: {
                labels: {{ team_lead_labels|safe }},
                datasets: [{
                    label: 'Active Projects',
                    data: teamLeadData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    // Stage Delay Bar Chart
    const stageDelayCtx = document.getElementById('stageDelayChart');
    const stageDelayData = {{ stage_delay_data|safe }};
    if (stageDelayCtx && stageDelayData.length > 0) {
        new Chart(stageDelayCtx, {
            type: 'bar',
            data: {
                labels: {{ stage_delay_labels|safe }},
                datasets: [{
                    label: 'Delayed Projects',
                    data: stageDelayData,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }
    
    // ✅ NEW: Call the function to make the cards the same height
    equalizeChartCardHeights();
    // Optional: Re-run when the window is resized
    window.addEventListener('resize', equalizeChartCardHeights);
});

// Function to clear inputs for a specific stage row
function clearStageRow(btn) {
    const row = btn.closest('.row');
    row.querySelectorAll('input, select').forEach(el => {
        if (el.tagName === 'SELECT' && el.multiple) {
             Array.from(el.options).forEach(opt => opt.selected = false);
        } else {
            el.value = '';
        }
    });
}
</script>

<script>
    // The filterTable function remains unchanged
    function filterTable() {
        const filterValues = {
            code: document.querySelector('.table-filter-row th:nth-child(1) input').value.toUpperCase(),

            customer: document.querySelector('.table-filter-row th:nth-child(2) input').value.toUpperCase(),
            segment: document.querySelector('.table-filter-row th:nth-child(3) input').value.toUpperCase(),
            teamLead: document.querySelector('.table-filter-row th:nth-child(4) input').value.toUpperCase(),
            status: document.querySelector('.table-filter-row th:nth-child(7) input').value.toUpperCase()

        };
        const tableBody = document.querySelector('.table-custom tbody');
        if (!tableBody) { return; }
        const allRows = tableBody.getElementsByTagName('tr');
        let visibleProjectCount = 0;
        let noResultsRow = null;
        for (let i = 0; i < allRows.length; i++) {
            const row = allRows[i];
            if (row.classList.contains('details-row')) { continue; }
            if (row.cells.length === 1 && row.cells[0].hasAttribute('colspan')) {
                noResultsRow = row;
                continue;
            }
            const detailsRow = allRows[i + 1];
            const rowData = {
                code: row.cells[0]?.textContent.toUpperCase() || '',
                customer: row.cells[1]?.textContent.toUpperCase() || '',
                segment: row.cells[2]?.textContent.toUpperCase() || '',

                teamLead: row.cells[3]?.textContent.toUpperCase() || '',
                status: row.cells[6]?.textContent.toUpperCase() || ''

            };
            const isMatch = rowData.code.includes(filterValues.code) &&
                            rowData.customer.includes(filterValues.customer) &&
                            rowData.segment.includes(filterValues.segment) &&
                            rowData.teamLead.includes(filterValues.teamLead) &&

                            rowData.status.includes(filterValues.status);
            if (isMatch) {
                row.style.display = 'table-row';
                if (detailsRow) detailsRow.style.display = 'table-row';
                visibleProjectCount++;
            } else {
                row.style.display = 'none';
                if (detailsRow) detailsRow.style.display = 'none';
            }
        }
        if (noResultsRow) {
            noResultsRow.style.display = (visibleProjectCount === 0) ? 'table-row' : 'none';
        }
    }
</script>
{% endblock %}