{% extends 'base_forum.html' %}
{% load static %}

{% block title %}Knowledge Base{% endblock %}

{% block styles %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap');

  :root {
    --kb-bg: #0f0f12;
    --kb-bg-soft: #1a1a24;
    --kb-card: rgba(255, 255, 255, 0.04);
    --kb-card-hover: rgba(255, 255, 255, 0.08);
    --kb-border: rgba(255, 255, 255, 0.1);
    --kb-text: #e8e8ed;
    --kb-muted: rgba(255, 255, 255, 0.55);
    --kb-accent: #6366f1;
    --kb-accent-2: #8b5cf6;
    --kb-bug: #ef4444;
    --kb-feature: #8b5cf6;
    --kb-success: #22c55e;
  }

  body {
    background: linear-gradient(135deg, #0f0f12 0%, #1a1a24 50%, #0f0f12 100%) !important;
    color: var(--kb-text) !important;
  }

  main {
    background: transparent !important;
  }

  .kb-page {
    min-height: 100vh;
    padding: 24px 32px 48px;
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .kb-glass {
    background: var(--kb-card);
    border: 1px solid var(--kb-border);
    backdrop-filter: blur(18px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
  }

  .kb-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    padding: 20px 28px;
    border-radius: 18px;
  }

  .kb-title {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .kb-logo {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--kb-accent) 0%, var(--kb-accent-2) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 20px;
  }

  .kb-title h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    font-family: 'Space Grotesk', 'DM Sans', sans-serif;
  }

  .kb-title p {
    margin: 0;
    font-size: 13px;
    color: var(--kb-muted);
  }

  .kb-search {
    position: relative;
    flex: 1;
    max-width: 420px;
  }

  .kb-search input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border-radius: 12px;
    border: 1px solid var(--kb-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--kb-text);
    font-size: 14px;
  }

  .kb-search input:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
  }

  .kb-search i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--kb-muted);
  }

  .kb-action {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--kb-accent) 0%, var(--kb-accent-2) 100%);
    color: #fff;
    font-weight: 600;
    text-decoration: none;
  }

  .kb-tabs {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .kb-tab {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    border-radius: 12px;
    border: 1px solid var(--kb-border);
    background: rgba(255, 255, 255, 0.03);
    color: var(--kb-muted);
    font-weight: 600;
    cursor: pointer;
  }

  .kb-tab.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
    border-color: rgba(99, 102, 241, 0.4);
    color: #c4b5fd;
  }

  .kb-tab span {
    padding: 2px 10px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    font-size: 12px;
  }

  .kb-main {
    margin-top: 26px;
    display: grid;
    grid-template-columns: 240px minmax(0, 1fr);
    gap: 28px;
  }

  .kb-sidebar {
    padding: 20px;
    border-radius: 16px;
  }

  .kb-sidebar h3 {
    margin: 0 0 16px;
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--kb-muted);
  }

  .kb-filter {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
  }

  .kb-filter button {
    background: none;
    border: 1px solid transparent;
    border-radius: 999px;
    padding: 8px 14px;
    color: var(--kb-muted);
    font-size: 13px;
    text-align: left;
    cursor: pointer;
  }

  .kb-filter button.active {
    background: rgba(99, 102, 241, 0.2);
    color: #c4b5fd;
    border-color: rgba(99, 102, 241, 0.3);
  }

  .kb-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--kb-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--kb-text);
    font-size: 13px;
  }

  .kb-content {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .kb-card {
    padding: 18px 20px;
    border-radius: 16px;
    transition: transform 0.2s ease, background 0.2s ease;
    text-decoration: none;
    color: inherit;
  }

  .kb-card:hover {
    background: var(--kb-card-hover);
    transform: translateY(-2px);
  }

  .kb-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
  }

  .kb-tag {
    background: rgba(99, 102, 241, 0.15);
    color: #a5b4fc;
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
    font-weight: 600;
  }

  .status-open { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
  .status-in_progress { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
  .status-resolved { background: rgba(34, 197, 94, 0.2); color: #86efac; }
  .status-closed { background: rgba(107, 114, 128, 0.2); color: #d1d5db; }

  .priority-critical { background: rgba(239, 68, 68, 0.18); color: #fca5a5; }
  .priority-high { background: rgba(249, 115, 22, 0.18); color: #fdba74; }
  .priority-medium { background: rgba(234, 179, 8, 0.18); color: #fde68a; }
  .priority-low { background: rgba(34, 197, 94, 0.18); color: #86efac; }

  .type-bug { background: rgba(239, 68, 68, 0.15); color: var(--kb-bug); }
  .type-feature { background: rgba(139, 92, 246, 0.15); color: var(--kb-feature); }

  .kb-empty {
    text-align: center;
    padding: 48px 20px;
    color: var(--kb-muted);
  }

  .kb-meta {
    display: flex;
    gap: 16px;
    align-items: center;
    font-size: 12px;
    color: var(--kb-muted);
    flex-wrap: wrap;
  }

  .kb-stat {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .kb-tab-pane,
  .kb-tab-sidebar {
    display: none;
  }

  .kb-tab-pane.active,
  .kb-tab-sidebar.active {
    display: block;
  }

  @media (max-width: 960px) {
    .kb-header {
      flex-direction: column;
      align-items: stretch;
    }

    .kb-search {
      max-width: 100%;
    }

    .kb-main {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="kb-page">
  <div class="kb-glass kb-header">
    <div class="kb-title">
      <div class="kb-logo"><i class="fas fa-book"></i></div>
      <div>
        <h1>Knowledge Base</h1>
        <p>Wiki, Q and A, Bug Reports and Feature Requests</p>
      </div>
    </div>
    <div class="kb-search">
      <i class="fas fa-search"></i>
      <input id="kb-search" type="text" placeholder="Search articles, questions, or reports" />
    </div>
    <a class="kb-action" href="{% url 'kb-create' %}">
      <i class="fas fa-plus"></i>
      Contribute
    </a>
  </div>

  <div class="kb-tabs">
    <button class="kb-tab active" data-tab-button="wiki">
      <i class="fas fa-book-open"></i>
      Wiki Articles
      <span>{{ total_articles }}</span>
    </button>
    <button class="kb-tab" data-tab-button="qa">
      <i class="fas fa-comments"></i>
      Q and A
      <span>{{ total_questions }}</span>
    </button>
    <button class="kb-tab" data-tab-button="reports">
      <i class="fas fa-bug"></i>
      Bug Reports and Features
      <span>{{ open_bugs|add:open_features }}</span>
    </button>
  </div>

  <div class="kb-main">
    <aside class="kb-glass kb-sidebar kb-tab-sidebar active" data-tab-sidebar="wiki">
      <h3>Categories</h3>
      <div class="kb-filter" data-filter="wiki-category">
        <button class="active" data-value="all">All</button>
        {% for category in categories %}
        <button data-value="{{ category.slug }}">{{ category.name }}</button>
        {% endfor %}
      </div>

      <h3>Quick stats</h3>
      <div class="kb-meta">
        <span class="kb-stat"><i class="fas fa-book"></i>{{ total_articles }} articles</span>
        <span class="kb-stat"><i class="fas fa-comment"></i>{{ total_interactions }} replies</span>
        <span class="kb-stat"><i class="fas fa-user"></i>{{ total_users }} users</span>
      </div>
    </aside>

    <aside class="kb-glass kb-sidebar kb-tab-sidebar" data-tab-sidebar="qa">
      <h3>Status</h3>
      <select class="kb-select" id="qa-status">
        <option value="all">All questions</option>
        <option value="solved">Solved</option>
        <option value="unsolved">Unsolved</option>
      </select>

      <h3 style="margin-top: 20px;">Helpful tips</h3>
      <div class="kb-meta">
        <span class="kb-stat"><i class="fas fa-check-circle"></i>Mark solutions</span>
        <span class="kb-stat"><i class="fas fa-search"></i>Search first</span>
      </div>
    </aside>

    <aside class="kb-glass kb-sidebar kb-tab-sidebar" data-tab-sidebar="reports">
      <h3>Type</h3>
      <select class="kb-select" id="report-type">
        <option value="all">All types</option>
        <option value="bug">Bug</option>
        <option value="feature">Feature</option>
      </select>

      <h3 style="margin-top: 20px;">Status</h3>
      <select class="kb-select" id="report-status">
        <option value="all">All status</option>
        <option value="open">Open</option>
        <option value="in_progress">In progress</option>
        <option value="resolved">Resolved</option>
        <option value="closed">Closed</option>
      </select>

      <h3 style="margin-top: 20px;">Priority</h3>
      <select class="kb-select" id="report-priority">
        <option value="all">All priority</option>
        <option value="critical">Critical</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>

      <h3 style="margin-top: 20px;">Open items</h3>
      <div class="kb-meta">
        <span class="kb-stat" style="color: #fca5a5;">{{ open_bugs }} bugs</span>
        <span class="kb-stat" style="color: #c4b5fd;">{{ open_features }} features</span>
      </div>
    </aside>

    <section class="kb-tab-pane active" data-tab-pane="wiki">
      <div class="kb-content" id="wiki-list">
        {% for article in articles %}
        <a
          class="kb-glass kb-card"
          href="{% url 'kb-article-detail' article.slug %}"
          data-item
          data-category="{{ article.category.slug }}"
          data-search="{{ article.title|lower }} {{ article.content|lower }} {{ article.category.name|lower }}">
          <div style="display: flex; justify-content: space-between; gap: 16px;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                <span class="kb-pill" style="background: rgba(99, 102, 241, 0.2); color: #c4b5fd;">
                  {{ article.category.name }}
                </span>
                <span class="kb-meta">Updated {{ article.updated_at|timesince }} ago</span>
              </div>
              <h3 style="margin: 0 0 8px; font-size: 18px;">{{ article.title }}</h3>
              <p style="margin: 0 0 12px; color: var(--kb-muted);">{{ article.excerpt|default:article.content|truncatewords:24 }}</p>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                {% for tag in article.tags.all %}
                <span class="kb-tag">{{ tag.name }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="kb-meta" style="flex-direction: column; align-items: flex-end;">
              <span class="kb-stat"><i class="fas fa-eye"></i>{{ article.views }}</span>
              <span class="kb-stat"><i class="fas fa-user"></i>{{ article.author.get_full_name|default:article.author.username }}</span>
            </div>
          </div>
        </a>
        {% empty %}
        <div class="kb-empty">No wiki articles yet.</div>
        {% endfor %}
      </div>
    </section>

    <section class="kb-tab-pane" data-tab-pane="qa">
      <div class="kb-content" id="qa-list">
        {% for question in questions %}
        <a
          class="kb-glass kb-card"
          href="{% url 'kb-question-detail' question.pk %}"
          data-item
          data-solved="{% if question.is_solved %}true{% else %}false{% endif %}"
          data-search="{{ question.title|lower }} {{ question.body|lower }} {{ question.author.username|lower }}">
          <div style="display: flex; gap: 16px; align-items: flex-start;">
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: center; min-width: 60px;">
              <span class="kb-meta">{{ question.answer_count }}</span>
              <span class="kb-meta">answers</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                <h3 style="margin: 0; font-size: 17px;">{{ question.title }}</h3>
                {% if question.is_solved %}
                <span class="kb-pill" style="background: rgba(34, 197, 94, 0.2); color: #86efac;">Solved</span>
                {% endif %}
              </div>
              <p style="margin: 0 0 10px; color: var(--kb-muted);">{{ question.body|truncatewords:24 }}</p>
              <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  {% for tag in question.tags.all %}
                  <span class="kb-tag">{{ tag.name }}</span>
                  {% endfor %}
                </div>
                <div class="kb-meta">
                  <span>{{ question.answer_count }} answers</span>
                  <span>{{ question.author.get_full_name|default:question.author.username }} - {{ question.created_at|timesince }} ago</span>
                </div>
              </div>
            </div>
          </div>
        </a>
        {% empty %}
        <div class="kb-empty">No questions available yet.</div>
        {% endfor %}
      </div>
    </section>

    <section class="kb-tab-pane" data-tab-pane="reports">
      <div class="kb-content" id="report-list">
        {% for report in reports %}
        <a
          class="kb-glass kb-card"
          href="{% url 'kb-report-detail' report.pk %}"
          data-item
          data-type="{{ report.type }}"
          data-status="{{ report.status }}"
          data-priority="{{ report.priority }}"
          data-search="{{ report.title|lower }} {{ report.description|lower }} {{ report.application.name|lower }}">
          <div style="display: flex; justify-content: space-between; gap: 16px; margin-bottom: 10px;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                <span class="kb-pill {% if report.type == 'bug' %}type-bug{% else %}type-feature{% endif %}">
                  {% if report.type == 'bug' %}
                  <i class="fas fa-bug"></i>
                  Bug
                  {% else %}
                  <i class="fas fa-lightbulb"></i>
                  Feature
                  {% endif %}
                </span>
                <span class="kb-meta">#{{ report.id }}</span>
                <h3 style="margin: 0; font-size: 17px;">{{ report.title }}</h3>
              </div>
              <p style="margin: 0 0 10px; color: var(--kb-muted);">{{ report.description|truncatewords:26 }}</p>
            </div>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <span class="kb-pill priority-{{ report.priority }}">{{ report.get_priority_display }}</span>
              <span class="kb-pill status-{{ report.status }}">{{ report.get_status_display }}</span>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <span class="kb-pill" style="background: rgba(139, 92, 246, 0.18); color: #c4b5fd;">{{ report.application.name }}</span>
              {% for tag in report.tags.all %}
              <span class="kb-tag">{{ tag.name }}</span>
              {% endfor %}
            </div>
            <div class="kb-meta">
              <span>{{ report.comment_count }} comments</span>
              <span>{{ report.reporter.get_full_name|default:report.reporter.username }}</span>
              <span>{{ report.updated_at|timesince }} ago</span>
            </div>
          </div>
        </a>
        {% empty %}
        <div class="kb-empty">No reports yet.</div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const tabs = document.querySelectorAll('[data-tab-button]');
    const panes = document.querySelectorAll('[data-tab-pane]');
    const sidebars = document.querySelectorAll('[data-tab-sidebar]');
    const searchInput = document.getElementById('kb-search');
    const wikiFilter = document.querySelector('[data-filter="wiki-category"]');
    const qaStatus = document.getElementById('qa-status');
    const reportType = document.getElementById('report-type');
    const reportStatus = document.getElementById('report-status');
    const reportPriority = document.getElementById('report-priority');

    let activeTab = 'wiki';
    let activeWikiCategory = 'all';

    function setActiveTab(tab) {
      activeTab = tab;
      tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tabButton === tab));
      panes.forEach(pane => pane.classList.toggle('active', pane.dataset.tabPane === tab));
      sidebars.forEach(sidebar => sidebar.classList.toggle('active', sidebar.dataset.tabSidebar === tab));
      applyFilters();
    }

    function updateEmptyState(container) {
      const items = container.querySelectorAll('[data-item]');
      const visible = Array.from(items).some(item => !item.classList.contains('is-hidden'));
      let empty = container.querySelector('.kb-empty.dynamic');
      if (!visible) {
        if (!empty) {
          empty = document.createElement('div');
          empty.className = 'kb-empty dynamic';
          empty.textContent = 'No matching results.';
          container.appendChild(empty);
        }
      } else if (empty) {
        empty.remove();
      }
    }

    function applyFilters() {
      const query = (searchInput.value || '').toLowerCase().trim();
      const activePane = document.querySelector(`[data-tab-pane="${activeTab}"]`);
      if (!activePane) {
        return;
      }

      const items = activePane.querySelectorAll('[data-item]');
      items.forEach(item => {
        const haystack = item.dataset.search || '';
        let visible = !query || haystack.includes(query);

        if (activeTab === 'wiki') {
          const category = item.dataset.category || '';
          if (activeWikiCategory !== 'all' && category !== activeWikiCategory) {
            visible = false;
          }
        }

        if (activeTab === 'qa') {
          const solved = item.dataset.solved === 'true';
          if (qaStatus.value === 'solved' && !solved) {
            visible = false;
          }
          if (qaStatus.value === 'unsolved' && solved) {
            visible = false;
          }
        }

        if (activeTab === 'reports') {
          if (reportType.value !== 'all' && item.dataset.type !== reportType.value) {
            visible = false;
          }
          if (reportStatus.value !== 'all' && item.dataset.status !== reportStatus.value) {
            visible = false;
          }
          if (reportPriority.value !== 'all' && item.dataset.priority !== reportPriority.value) {
            visible = false;
          }
        }

        item.classList.toggle('is-hidden', !visible);
        item.style.display = visible ? '' : 'none';
      });

      updateEmptyState(activePane.querySelector('.kb-content'));
    }

    tabs.forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tabButton));
    });

    if (wikiFilter) {
      wikiFilter.addEventListener('click', event => {
        const target = event.target.closest('button');
        if (!target) {
          return;
        }
        activeWikiCategory = target.dataset.value || 'all';
        wikiFilter.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn === target));
        applyFilters();
      });
    }

    [searchInput, qaStatus, reportType, reportStatus, reportPriority].forEach(control => {
      if (!control) {
        return;
      }
      control.addEventListener('input', applyFilters);
      control.addEventListener('change', applyFilters);
    });
  })();
</script>
{% endblock %}
