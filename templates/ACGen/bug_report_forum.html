{% extends "base.html" %}



{% block content %}

<div class="container mt-4">

    <h1 class="mb-3">AutoVerse Bug Reports</h1>

    <p class="text-muted">

        Share detailed bug reports to help the team reproduce and resolve issues faster.

    </p>



    <section class="card mb-4">

        <div class="card-body">

            <h2 class="h5 card-title">Create a Report</h2>

            <p class="card-text">

                Submit a new bug report using the form below. Attach screenshots and include the exact steps that led to the issue.

            </p>

            <form method="post" enctype="multipart/form-data" class="row g-3">

                {% csrf_token %}

                {% if form.non_field_errors %}

                    <div class="col-12">

                        <div class="alert alert-danger">

                            {% for error in form.non_field_errors %}

                                <div>{{ error }}</div>

                            {% endfor %}

                        </div>

                    </div>

                {% endif %}

                {% for field in form %}

                    <div class="col-12">

                        <label class="form-label" for="{{ field.id_for_label }}">

                            {{ field.label }}

                            {% if field.field.required %}

                                <span class="text-danger">*</span>

                            {% endif %}

                        </label>

                        {{ field }}

                        {% if field.help_text %}

                            <div class="form-text">{{ field.help_text }}</div>

                        {% endif %}

                        {% for error in field.errors %}

                            <div class="invalid-feedback d-block">{{ error }}</div>

                        {% endfor %}

                    </div>

                {% endfor %}

                <div class="col-12">

                    <button class="btn btn-primary" type="submit">Submit Bug Report</button>

                </div>

            </form>

        </div>

    </section>



    <section>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">

            <h2 class="h5 mb-0">Recent Reports</h2>

            <form method="get" class="d-flex align-items-center gap-2">

                <label class="form-label mb-0" for="status-filter">Filter by status:</label>

                <select id="status-filter" name="status" class="form-select form-select-sm w-auto">

                    <option value="" {% if not status_filter %}selected{% endif %}>All</option>

                    {% for value, label in status_choices %}

                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>

                    {% endfor %}

                </select>

                <button class="btn btn-secondary btn-sm" type="submit">Apply</button>

                {% if status_filter %}

                    <a class="btn btn-link btn-sm" href="{% url 'bug-report-dashboard' %}">Clear</a>

                {% endif %}

            </form>

        </div>



        {% if reports %}

            <div class="list-group">

                {% for entry in reports %}

                    {% with report=entry.report status_form=entry.status_form %}

                        <article class="list-group-item list-group-item-action">

                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start">

                                <div>

                                    <h3 class="h5 mb-1">{{ report.title }}</h3>

                                    <p class="mb-1 text-muted">
                                        Reported by {{ report.reported_by }} - {{ report.created_at|date:"M j, Y H:i" }}
                                    </p>

                                    <span class="badge bg-secondary text-uppercase">{{ report.get_status_display }}</span>

                                    <span class="badge bg-light text-dark ms-1">Version {{ report.application_version }}</span>

                                </div>

                            </div>

                            <div class="mt-3">

                                <h4 class="h6">Steps to Reproduce</h4>

                                <p class="mb-2">{{ report.steps_to_reproduce|default:"Not provided." }}</p>

                                <h4 class="h6">Log Snippet</h4>

                                <pre class="bg-light p-2 rounded">{{ report.log_text|default_if_none:""|default:"Not provided." }}</pre>

                                <h4 class="h6">Current Status Notes</h4>

                                <p class="mb-2">{{ report.current_status_details|default:"Not provided." }}</p>

                                {% with attachments=report.attachments.all %}

                                    {% if report.screenshot or attachments %}

                                        <h4 class="h6">Screenshots</h4>

                                        <div class="d-flex flex-wrap gap-2">

                                            {% if report.screenshot %}

                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#screenshotModal" data-image-url="{{ report.screenshot.url }}" data-image-name="{{ report.screenshot.name|default:'Screenshot' }}">

                                                    Original Screenshot

                                                </button>

                                            {% endif %}

                                            {% for attachment in attachments %}

                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#screenshotModal" data-image-url="{{ attachment.image.url }}" data-image-name="{{ attachment.original_name|default:'Screenshot' }}">

                                                    {{ attachment.original_name|default:'Screenshot' }}

                                                </button>

                                            {% endfor %}

                                        </div>

                                    {% endif %}

                                {% endwith %}

                            </div>

                            {% if entry.can_update %}

                                <div class="mt-3">

                                    <form method="post" action="{% url 'bug-report-update-status' report.id %}" class="row g-2 align-items-end">

                                        {% csrf_token %}

                                        <input type="hidden" name="next" value="{{ current_path }}">

                                        <div class="col-md-4">

                                            {{ status_form.status.label_tag }}

                                            {{ status_form.status }}

                                            {% for error in status_form.status.errors %}

                                                <div class="invalid-feedback d-block">{{ error }}</div>

                                            {% endfor %}

                                        </div>

                                        <div class="col-md-6">

                                            {{ status_form.current_status_details.label_tag }}

                                            {{ status_form.current_status_details }}

                                            {% for error in status_form.current_status_details.errors %}

                                                <div class="invalid-feedback d-block">{{ error }}</div>

                                            {% endfor %}

                                        </div>

                                        <div class="col-md-2">

                                            <button class="btn btn-primary w-100" type="submit">Update</button>

                                        </div>

                                    </form>

                                </div>

                            {% endif %}

                        </article>

                    {% endwith %}

                {% endfor %}

            </div>

        {% else %}

            <div class="alert alert-info">

                No bug reports found for the selected criteria.

            </div>

        {% endif %}

    </section>

</div>





<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered">

        <div class="modal-content">

            <div class="modal-header">

                <h5 class="modal-title" id="screenshotModalLabel">Screenshot preview</h5>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>

            <div class="modal-body text-center">

                <img src="" alt="Screenshot preview" class="img-fluid rounded shadow-sm">

            </div>

        </div>

    </div>

</div>



<script>

document.addEventListener("DOMContentLoaded", () => {

    const screenshotModal = document.getElementById("screenshotModal");

    if (!screenshotModal) {

        return;

    }

    screenshotModal.addEventListener("show.bs.modal", event => {

        const trigger = event.relatedTarget;

        if (!trigger) {

            return;

        }

        const imageUrl = trigger.getAttribute("data-image-url");

        const imageName = trigger.getAttribute("data-image-name") || "Screenshot preview";

        const modalImage = screenshotModal.querySelector("img");

        const modalTitle = screenshotModal.querySelector(".modal-title");



        modalImage.src = imageUrl;

        modalImage.alt = imageName;

        modalTitle.textContent = imageName;

    });



    screenshotModal.addEventListener("hidden.bs.modal", () => {

        const modalImage = screenshotModal.querySelector("img");

        modalImage.src = "";

        modalImage.alt = "Screenshot preview";

    });

});

</script>

{% endblock %}

