<!-- 
################################################################################
# FILE 3: templates/inventory/unified_transfer_form.html (CREATE NEW FILE)
################################################################################ -->

{% extends 'inventory/base.html' %}

{% block title %}Transfer Items{% endblock %}

{% block extra_css %}
<style>
    .transfer-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 1rem;
        color: white;
        margin-bottom: 2rem;
    }
    
    .transfer-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .transfer-type-btn {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .transfer-type-btn.active {
        border-color: #4299e1;
        background: #ebf8ff;
        transform: scale(1.02);
    }
    
    .transfer-type-btn:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="transfer-section">
        <h2 class="text-3xl font-bold mb-2">
            <i class="fas fa-exchange-alt mr-2"></i>Transfer Management
        </h2>
        <p class="text-blue-100">Assign, transfer, or dispatch items</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Transfer Form -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">New Transfer</h3>
            
            <form method="post" id="transferForm">
                {% csrf_token %}
                
                <!-- Action Type Selection -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for choice in form.transfer_type %}
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer action-type-option">
                                {{ choice.tag }}
                                <div class="ml-3">
                                    <div class="font-medium">{{ choice.choice_label }}</div>
                                    <div class="text-xs text-gray-500">
                                        {% if choice.choice_value == 'assign' %}
                                            Assign available items or transfer between users
                                        {% else %}
                                            Send items to projects (materials only)
                                        {% endif %}
                                    </div>
                                </div>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Item Selection (combined assigned and available) -->
                <div id="assign-fields" class="transfer-section-fields space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.assignment.label }}</label>
                            {{ form.assignment }}
                            <p class="text-xs text-gray-500 mt-1">Select to transfer between users</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.available_item.label }}</label>
                            {{ form.available_item }}
                            <p class="text-xs text-gray-500 mt-1">Select to assign to a user</p>
                        </div>
                    </div>
                    <div class="text-sm text-blue-600 bg-blue-50 p-2 rounded">
                        <i class="fas fa-info-circle mr-1"></i>
                        Choose either an assigned item (to transfer) OR an available item (to assign) - not both.
                    </div>
                </div>
                
                <!-- User Selection (for assign and transfer) -->
                <div id="user-fields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.assigned_to.label }}</label>
                        {{ form.assigned_to }}
                    </div>
                </div>
                
                <!-- Project Fields (for dispatch) -->
                <div id="project-fields" class="transfer-section-fields space-y-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.project.label }} <span class="text-red-500">*</span></label>
                            {{ form.project }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.site_location.label }}</label>
                            {{ form.site_location }}
                        </div>
                    </div>
                </div>
                
                <!-- Common Fields -->
                <div class="space-y-4 mt-6 pt-6 border-t">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" id="date-label">{{ form.transfer_date.label }}</label>
                            {{ form.transfer_date }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.expected_return_date.label }}</label>
                            {{ form.expected_return_date }}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ form.notes.label }}</label>
                        {{ form.notes }}
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <a href="{% url 'item-list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md">
                        Cancel
                    </a>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md" id="submit-btn">
                        <i class="fas fa-user-plus mr-2" id="submit-icon"></i>
                        <span id="submit-text">Assign/Transfer</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Current Items List -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Items Status</h3>
            
            <!-- Active Assignments -->
            <div class="mb-6" id="assigned-items-section">
                <h4 class="font-medium text-gray-700 mb-3">
                    <i class="fas fa-user-check mr-1"></i>Currently Assigned Items
                </h4>
                {% if active_assignments %}
                <div class="space-y-3 max-h-64 overflow-y-auto">
                    {% for assignment in active_assignments %}
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-medium text-gray-900">{{ assignment.item.name }}</h5>
                                <p class="text-sm text-gray-600">{{ assignment.item.serial_number }}</p>
                                <p class="text-sm text-blue-600">
                                    <i class="fas fa-user mr-1"></i>
                                    {{ assignment.assigned_to.get_full_name|default:assignment.assigned_to.username }}
                                </p>
                                <p class="text-xs text-gray-500">
                                    Since: {{ assignment.assignment_date }}
                                </p>
                            </div>
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Assigned</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    <p class="text-sm">No items currently assigned</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Available Items -->
            <div id="available-items-section">
                <h4 class="font-medium text-gray-700 mb-3">
                    <i class="fas fa-box mr-1"></i>Available Items
                </h4>
                {% if available_items %}
                <div class="space-y-3 max-h-64 overflow-y-auto">
                    {% for item in available_items %}
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-medium text-gray-900">{{ item.name }}</h5>
                                <p class="text-sm text-gray-600">{{ item.serial_number }}</p>
                                <p class="text-sm text-green-600">
                                    <i class="fas fa-tag mr-1"></i>{{ item.get_item_type_display }}
                                </p>
                                {% if item.location %}
                                <p class="text-xs text-gray-500">
                                    <i class="fas fa-map-marker-alt mr-1"></i>{{ item.location }}
                                </p>
                                {% endif %}
                            </div>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Available</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    <p class="text-sm">No items available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Links -->
    <div class="mt-6 flex justify-center space-x-4">
        <a href="{% url 'history-list' %}" class="text-purple-600 hover:text-purple-800">
            <i class="fas fa-history mr-1"></i>View History
        </a>
        <a href="{% url 'reports' %}" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-chart-bar mr-1"></i>View Reports
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date
    const transferDateInput = document.querySelector('input[name="transfer_date"]');
    if (transferDateInput && !transferDateInput.value) {
        transferDateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Handle action type changes
    const actionTypeRadios = document.querySelectorAll('input[name="transfer_type"]');
    const assignFields = document.getElementById('assign-fields');
    const userFields = document.getElementById('user-fields');
    const projectFields = document.getElementById('project-fields');
    const submitBtn = document.getElementById('submit-btn');
    const submitIcon = document.getElementById('submit-icon');
    const submitText = document.getElementById('submit-text');
    const dateLabel = document.getElementById('date-label');
    
    function updateForm() {
        const selectedAction = document.querySelector('input[name="transfer_type"]:checked').value;
        
        // Hide all sections first
        assignFields.style.display = 'none';
        userFields.style.display = 'none';
        projectFields.style.display = 'none';
        
        if (selectedAction === 'assign') {
            assignFields.style.display = 'block';
            userFields.style.display = 'block';
            submitBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md';
            submitIcon.className = 'fas fa-user-plus mr-2';
            submitText.textContent = 'Assign/Transfer';
            dateLabel.textContent = 'Date';
            
        } else if (selectedAction === 'dispatch') {
            assignFields.style.display = 'block';
            projectFields.style.display = 'block';
            submitBtn.className = 'bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md';
            submitIcon.className = 'fas fa-truck mr-2';
            submitText.textContent = 'Dispatch Item';
            dateLabel.textContent = 'Dispatch Date';
        }
    }
    
    actionTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateForm);
    });
    
    // Initialize form state
    updateForm();
});
</script>
{% endblock %}

