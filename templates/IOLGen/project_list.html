{% extends "base.html" %}
{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'dashboard/project-cards.css' %}">
{% endblock styles %}
  
{% block content %}
<div class="container mx-auto p-6">

  <h1 class="text-3xl font-bold mb-6">Projects</h1>

  <!-- Filter bar -->
  <div id="filter-bar" class="flex flex-wrap items-center mb-6 space-x-4">
    <input
      id="searchInput"
      type="text"
      placeholder="Search by name, description or creatorâ€¦"
      class="flex-grow border rounded p-2"
    />
    <select id="segmentFilter" class="border rounded p-2">
      <option value="">All segments</option>
      {% for seg in segments %}
        <option value="{{ seg.name }}">{{ seg.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Projects grid -->
<!-- NEW: flex layout with responsive widths -->
<div id="projectsGrid" class="flex flex-wrap gap-6 projects-grid">
  {% for project in projects %}
  <div
    class="project-card"
    data-name="{{ project.name|lower }}"
    data-description="{{ project.description|lower }}"
    data-creator="{{ project.created_by.username|lower }}"
    data-segments="{% for s in project.segments.all %}{{ s.name|lower }}{% if not forloop.last %}, {% endif %}{% endfor %}"
  >
    <div class="project-header">
      <h2 class="project-title">{{ project.name }}</h2>
      <a href="{% url 'iolist_edit' project.id %}" class="btn btn-edit">Edit</a>
    </div>

    <p class="project-description">{{ project.description }}</p>

    <div class="project-meta">
      {% if project.PLC %}
        <div class="meta-item"><strong>PLC:</strong> {{ project.PLC.name }}</div>
      {% endif %}
      {% if project.segments.all %}
        <div class="meta-item">
          <strong>Segments:</strong>
          {% for seg in project.segments.all %}
            {{ seg.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="project-footer">
      <div class="author">By {{ project.created_by.username }}</div>
      <div class="date">{{ project.created_at|date:"M j, Y" }}</div>
    </div>

    <div class="actions">
      <a href="#" class="btn btn-review">Review</a>
      <!--  url 'review_project' project.id  -->
    </div>
  </div>
  {% endfor %}
</div>

</div>

<script>
  (function(){
    const searchInput    = document.getElementById('searchInput');
    const segmentFilter  = document.getElementById('segmentFilter');
    const grid           = document.getElementById('projectsGrid');
    const cards          = Array.from(grid.getElementsByClassName('project-card'));

    function normalize(str) {
      return (str||'').toLowerCase();
    }

    function filterCards() {
      const text = normalize(searchInput.value);
      const seg  = normalize(segmentFilter.value);

      cards.forEach(card => {
        const name        = card.dataset.name;
        const desc        = card.dataset.description;
        const creator     = card.dataset.creator;
        const segments    = card.dataset.segments.split(',');

        const matchesText =
          !text ||
          name.includes(text)     ||
          desc.includes(text)     ||
          creator.includes(text);

        const matchesSeg =
          !seg ||
          segments.includes(seg);

        card.style.display = (matchesText && matchesSeg)
          ? ''  // show
          : 'none';  // hide
      });
    }

    searchInput.addEventListener('input', filterCards);
    segmentFilter.addEventListener('change', filterCards);
  })();
</script>
{% endblock %}
